<!DOCTYPE html><html lang="en-us" >

<head>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  
  
  <meta name="generator" content="Wowchemy 4.8.0 for Hugo">
  

  

  
  

  
  
  
  
  
    
    
    
  
  

  <meta name="author" content="Charlie Lehman">

  
  
  
    
  
  <meta name="description" content="SS-08:Dynamic Background Reconstruction/Subtraction for Challenging Environments">

  
  <link rel="alternate" hreflang="en-us" href="https://charlielehman.github.io/post/on-the-structures-of-representation/">

  







  




  
  
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  

  
  
  
  <meta name="theme-color" content="#2962ff">
  

  
  
  
  <script src="/js/mathjax-config.js"></script>
  

  
  
  
  
    
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.14.0/css/all.min.css" integrity="sha256-FMvZuGapsJLjouA6k7Eo2lusoAX9i0ShlWFG6qt7SLc=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.css" integrity="sha256-Vzbj7sDDS/woiFS3uNKo8eIuni59rjyNGtXfstRzStA=" crossorigin="anonymous">

    
    
    
      
    
    
      
      
        
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/github.min.css" crossorigin="anonymous" title="hl-light">
          <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/styles/dracula.min.css" crossorigin="anonymous" title="hl-dark" disabled>
        
      
    

    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.css" integrity="sha512-1xoFisiGdy9nvho8EgXuXvnpR5GAMSjFwp40gSRE3NwdUdIMIKuPa7bqoUhLD0O/5tPNhteAsE5XyyMi5reQVA==" crossorigin="anonymous">
    

    

    
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/lazysizes/5.2.2/lazysizes.min.js" integrity="sha512-TmDwFLhg3UA4ZG0Eb4MIyT1O1Mb+Oww5kFG0uHqXsdbyZz9DcvYQhKpGgNkamAI6h2lGGZq2X8ftOJvF/XjTUg==" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    
      

      
      

      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js" integrity="" crossorigin="anonymous" async></script>
      
    
      

      
      

      
    
      

      
      

      
    

  

  
  
  
    
      
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Montserrat:400,700%7CRoboto:400,400italic,700%7CRoboto+Mono&display=swap">
    
  

  
  
  
  
  <link rel="stylesheet" href="/css/wowchemy.css">

  





<script async src="https://www.googletagmanager.com/gtag/js?id=UA-153844641-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];

  function gtag() {
      dataLayer.push(arguments);
  }

  function trackOutboundLink(url, target) {
    gtag('event', 'click', {
         'event_category': 'outbound',
         'event_label': url,
         'transport_type': 'beacon',
         'event_callback': function () {
           if (target !== '_blank') {
             document.location = url;
           }
         }
    });
    console.debug("Outbound link clicked: " + url);
  }

  function onClickCallback(event) {
    if ((event.target.tagName !== 'A') || (event.target.host === window.location.host)) {
      return;
    }
    trackOutboundLink(event.target, event.target.getAttribute('target'));  
  }

  gtag('js', new Date());
  gtag('config', 'UA-153844641-1', {});

  
  document.addEventListener('click', onClickCallback, false);
</script>


  


  
  

  

  <link rel="manifest" href="/index.webmanifest">
  <link rel="icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_32x32_fill_lanczos_center_2.png">
  <link rel="apple-touch-icon" type="image/png" href="/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png">

  <link rel="canonical" href="https://charlielehman.github.io/post/on-the-structures-of-representation/">

  
  
  
  
  
  
  
    
    
  
  
  <meta property="twitter:card" content="summary">
  
  <meta property="og:site_name" content="Charlie Lehman">
  <meta property="og:url" content="https://charlielehman.github.io/post/on-the-structures-of-representation/">
  <meta property="og:title" content="On the Structures of Representation for the Robustness of Semantic Segmentation to Input Corruption | Charlie Lehman">
  <meta property="og:description" content="SS-08:Dynamic Background Reconstruction/Subtraction for Challenging Environments"><meta property="og:image" content="https://charlielehman.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png">
  <meta property="twitter:image" content="https://charlielehman.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_512x512_fill_lanczos_center_2.png"><meta property="og:locale" content="en-us">
  
    
      <meta property="article:published_time" content="2020-10-22T00:00:00&#43;00:00">
    
    <meta property="article:modified_time" content="2020-10-22T00:00:00&#43;00:00">
  

  


    






  




<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://charlielehman.github.io/post/on-the-structures-of-representation/"
  },
  "headline": "On the Structures of Representation for the Robustness of Semantic Segmentation to Input Corruption",
  
  "datePublished": "2020-10-22T00:00:00Z",
  "dateModified": "2020-10-22T00:00:00Z",
  
  "author": {
    "@type": "Person",
    "name": "Charlie Lehman"
  },
  
  "publisher": {
    "@type": "Organization",
    "name": "Charlie Lehman",
    "logo": {
      "@type": "ImageObject",
      "url": "https://charlielehman.github.io/images/icon_hu0b7a4cb9992c9ac0e91bd28ffd38dd00_9727_192x192_fill_lanczos_center_2.png"
    }
  },
  "description": "SS-08:Dynamic Background Reconstruction/Subtraction for Challenging Environments"
}
</script>

  

  


  


  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-153844641-1', 'auto');
	
	ga('send', 'pageview');
}
</script>



  <title>On the Structures of Representation for the Robustness of Semantic Segmentation to Input Corruption | Charlie Lehman</title>

</head>


<body id="top" data-spy="scroll" data-offset="70" data-target="#TableOfContents" class=" ">

  
  
  
    <script>window.wcDarkLightEnabled = true;</script>
  
  
    <script>const isSiteThemeDark = false;</script>
  
  
  <script src="/js/load-theme.js"></script>

  <aside class="search-results" id="search">
  <div class="container">
    <section class="search-header">

      <div class="row no-gutters justify-content-between mb-3">
        <div class="col-6">
          <h1>Search</h1>
        </div>
        <div class="col-6 col-search-close">
          <a class="js-search" href="#"><i class="fas fa-times-circle text-muted" aria-hidden="true"></i></a>
        </div>
      </div>

      <div id="search-box">
        
        <input name="q" id="search-query" placeholder="Search..." autocapitalize="off"
        autocomplete="off" autocorrect="off" spellcheck="false" type="search" class="form-control">
        
      </div>

    </section>
    <section class="section-search-results">

      <div id="search-hits">
        
      </div>

    </section>
  </div>
</aside>


  












<nav class="navbar navbar-expand-lg navbar-light compensate-for-scrollbar" id="navbar-main">
  <div class="container">

    
    <div class="d-none d-lg-inline-flex">
      <a class="navbar-brand" href="/">Charlie Lehman</a>
    </div>
    

    
    <button type="button" class="navbar-toggler" data-toggle="collapse"
            data-target="#navbar-content" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
    <span><i class="fas fa-bars"></i></span>
    </button>
    

    
    <div class="navbar-brand-mobile-wrapper d-inline-flex d-lg-none">
      <a class="navbar-brand" href="/">Charlie Lehman</a>
    </div>
    

    
    
    <div class="navbar-collapse main-menu-item collapse justify-content-start" id="navbar-content">

      
      <ul class="navbar-nav d-md-inline-flex">
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#profile"><span>Biography</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#skills"><span>Skills</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#experience"><span>Experience</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#posts"><span>Posts</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#projects"><span>Projects</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#talks"><span>Talks</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#publications"><span>Publications</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
            
            
            
              
            
            
          
        

        <li class="nav-item">
          <a class="nav-link " href="/#contact"><span>Contact</span></a>
        </li>

        
        

        

        
        
        
          
        

        

        
        
        
        

        
          
            
            
          
          
        

        <li class="nav-item">
          <a class="nav-link " href="/files/charlielehman_cv.pdf"><span>CV</span></a>
        </li>

        
        

      

        
      </ul>
    </div>

    <ul class="nav-icons navbar-nav flex-row ml-auto d-flex pl-md-2">
      
      
      <li class="nav-item">
        <a class="nav-link js-search" href="#" aria-label="Search"><i class="fas fa-search" aria-hidden="true"></i></a>
      </li>
      

      
      
      <li class="nav-item dropdown theme-dropdown">
        <a href="#" class="nav-link" data-toggle="dropdown" aria-haspopup="true">
          <i class="fas fa-moon" aria-hidden="true"></i>
        </a>
        <div class="dropdown-menu">
          <a href="#" class="dropdown-item js-set-theme-light">
            <span>Light</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-dark">
            <span>Dark</span>
          </a>
          <a href="#" class="dropdown-item js-set-theme-auto">
            <span>Automatic</span>
          </a>
        </div>
      </li>
      

      

    </ul>

  </div>
</nav>



  <article class="article">

  












  

  
  
  
<div class="article-container pt-3">
  <h1>On the Structures of Representation for the Robustness of Semantic Segmentation to Input Corruption</h1>

  

  
    


<div class="article-metadata">

  
  
  
  
  <div>
    

  
  <span class="author-highlighted"><a href="/author/charlie-lehman/">Charlie Lehman</a></span>, <span ><a href="/author/can-temel/">Can Temel</a></span>, <span ><a href="/author/ghassan-alregib/">Ghassan AlRegib</a></span>
  </div>
  
  

  
  <span class="article-date">
    
    
      
    
    Oct 22, 2020
  </span>
  

  

  
  <span class="middot-divider"></span>
  <span class="article-reading-time">
    25 min read
  </span>
  

  
  
  

  
  

</div>

    













<div class="btn-links mb-3">
  
  








  
    
  



<a class="btn btn-outline-primary my-1 mr-1" href="https://arxiv.org/abs/2009.00817" target="_blank" rel="noopener">
  PDF
</a>




  
  
    
  
<a class="btn btn-outline-primary my-1 mr-1" href="https://github.com/charlieLehman/segmentation_corruption" target="_blank" rel="noopener">
  Code
</a>










  
  
    
  
<a class="btn btn-outline-primary my-1 mr-1" href="https://www.youtube.com/watch?v=_CQRmiYqbXE" target="_blank" rel="noopener">
  Video
</a>





</div>


  
</div>



  <div class="article-container">

    <div class="article-style">
      <h2 id="introduction">Introduction</h2>
<p>I wanted to provide some additional resources beyond the above linked paper and code to reproduce our results.  Below is <strong>mostly</strong> the same code provided in the repository&mdash;things like prints, form renderings for Google Colab, and rendered tqdm progress bars have been removed.  Please be sure to expand the &ldquo;show code &gt;&rdquo; buttons to look at the code that generated the corresponding outputs/results.</p>
<h3 id="general-imports-and-visualiztion-methods">General Imports and Visualiztion methods</h3>
<p>We will be importing some of the required libraries here and build out the machinery for visualizing the results of this work.  Of note in <code>colorize_voc_label</code>, is assigning the color white to classes above 20.  This is to account for 255 being used to indicate the &ldquo;ignore&rdquo; class. For <code>visualize</code>, the assumption is the arguments are <code>torch.Tensor</code> instances that are the outputs of our models.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">import</span> torch
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial
<span style="color:#f92672">import</span> os
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">import</span> matplotlib
<span style="color:#f92672">%</span>matplotlib inline
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> pyplot <span style="color:#66d9ef">as</span> plt
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> gridspec
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> cm
<span style="color:#f92672">from</span> matplotlib.colors <span style="color:#f92672">import</span> ListedColormap, LinearSegmentedColormap

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">colorize_voc_label</span>(lbl):
    voc_colors <span style="color:#f92672">=</span>  [[<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>],
                   [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">128</span>], [<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">128</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>], [<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>],
                   [<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">0</span>],
                   [<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">128</span>], [<span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">128</span>], [<span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>], [<span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">128</span>],
                   [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">0</span>], [<span style="color:#ae81ff">128</span>, <span style="color:#ae81ff">192</span>, <span style="color:#ae81ff">0</span>],
                   [<span style="color:#ae81ff">0</span>, <span style="color:#ae81ff">64</span>, <span style="color:#ae81ff">128</span>]]
    voc_colors <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(voc_colors)<span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>
    voc_cmap <span style="color:#f92672">=</span> ListedColormap(voc_colors)
    cmap_lbl <span style="color:#f92672">=</span> voc_cmap(lbl<span style="color:#f92672">/</span><span style="color:#ae81ff">20</span>)
    cmap_lbl[lbl<span style="color:#f92672">&gt;</span><span style="color:#ae81ff">20</span>,:<span style="color:#ae81ff">3</span>] <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> cmap_lbl


<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visualize</span>(im, lbl, pred<span style="color:#f92672">=</span>None):
    im <span style="color:#f92672">=</span> im<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>numpy()
    lbl <span style="color:#f92672">=</span> lbl<span style="color:#f92672">.</span>squeeze()<span style="color:#f92672">.</span>numpy()
    cols <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span> <span style="color:#66d9ef">if</span> pred <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None <span style="color:#66d9ef">else</span> <span style="color:#ae81ff">2</span>
    fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,cols)
    im <span style="color:#f92672">=</span> ((im<span style="color:#f92672">*</span>MEAN_STD[<span style="color:#e6db74">&#39;std&#39;</span>]<span style="color:#f92672">+</span>MEAN_STD[<span style="color:#e6db74">&#39;mean&#39;</span>])<span style="color:#f92672">*</span><span style="color:#ae81ff">255</span>)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>uint8)
    ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>imshow(im)
    ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;Image&#39;</span>)
    ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>imshow(colorize_voc_label(lbl))
    ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;Label&#39;</span>)
    ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    <span style="color:#66d9ef">if</span> pred <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
        pred <span style="color:#f92672">=</span> pred<span style="color:#f92672">.</span>squeeze()<span style="color:#f92672">.</span>numpy()
        ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>imshow(colorize_voc_label(pred))
        ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;Pred&#39;</span>)
        ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
    <span style="color:#66d9ef">return</span> fig, ax</code></pre></div>
    </div>
</span>

<h3 id="segmentation-transforms">Segmentation Transforms</h3>
<p>Now we build out the joint transform used during training and validation that is compatible with <code>torchvision.datasets.VOCSegmentation</code>.  This requires the <code>joint_transforms</code> module provided in the above linked code.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> transforms
<span style="color:#f92672">import</span> joint_transforms

MEAN_STD <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;mean&#34;</span>:(<span style="color:#ae81ff">0.485</span>, <span style="color:#ae81ff">0.456</span>, <span style="color:#ae81ff">0.406</span>), <span style="color:#e6db74">&#34;std&#34;</span>:(<span style="color:#ae81ff">0.229</span>, <span style="color:#ae81ff">0.224</span>, <span style="color:#ae81ff">0.225</span>)}

base_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">224</span>
crop_size <span style="color:#f92672">=</span> <span style="color:#ae81ff">224</span>

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImLblTransform</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, train):
        self<span style="color:#f92672">.</span>joint_train <span style="color:#f92672">=</span> []
        im_tran <span style="color:#f92672">=</span>  [
            transforms<span style="color:#f92672">.</span>ToTensor(), 
            transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD)
        ]
        
        <span style="color:#66d9ef">if</span> train:
            self<span style="color:#f92672">.</span>joint_train<span style="color:#f92672">.</span>append(joint_transforms<span style="color:#f92672">.</span>RandomScaleCrop(base_size, crop_size, fill<span style="color:#f92672">=</span><span style="color:#ae81ff">255</span>))
            im_tran<span style="color:#f92672">.</span>insert(<span style="color:#ae81ff">0</span>,transforms<span style="color:#f92672">.</span>ColorJitter(brightness<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, contrast<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, saturation<span style="color:#f92672">=</span><span style="color:#ae81ff">0.3</span>, hue<span style="color:#f92672">=</span><span style="color:#ae81ff">0.1</span>)) 
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>joint_train<span style="color:#f92672">.</span>append(joint_transforms<span style="color:#f92672">.</span>FixScaleResize(base_size))
            
        self<span style="color:#f92672">.</span>img_transform <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose(im_tran)
            
    <span style="color:#66d9ef">def</span> __call__(self, img, lbl):
        <span style="color:#66d9ef">for</span> tfm <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>joint_train:
            img, lbl <span style="color:#f92672">=</span> tfm(img, lbl)
        img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>img_transform(img)
        lbl <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(lbl)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
        lbl <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(lbl)<span style="color:#f92672">.</span>float()
        <span style="color:#66d9ef">return</span> img, lbl</code></pre></div>
    </div>
</span>

<h3 id="voc2012">VOC2012</h3>
<p>Now to put our <code>visualize</code> method to work, we can look at the first image and label pair in the VOC2012 training set.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision.datasets <span style="color:#f92672">import</span> VOCSegmentation

voc_train <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, transforms<span style="color:#f92672">=</span>ImLblTransform(True))
voc_val <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, transforms<span style="color:#f92672">=</span>ImLblTransform(False), image_set<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val&#39;</span>)
im_,lbl_ <span style="color:#f92672">=</span> voc_train[<span style="color:#ae81ff">0</span>]
fig, ax <span style="color:#f92672">=</span> visualize(im_,lbl_)</code></pre></div>
    </div>
</span>

<p><img src="index_8_1.png" alt="png"></p>
<h3 id="sbd">SBD</h3>
<p>Next, we want to append the VOC2012 training set with the &ldquo;train_noval&rdquo; subset of SBDataset as provided by torchvision to have a total of 7087 training examples. Notice as we visualize an example from SBDataset that they differ in that the transitions from foreground to background is not bordered by the &ldquo;ignore&rdquo; class.</p>
<p>
<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision.datasets <span style="color:#f92672">import</span> SBDataset

sbd_train <span style="color:#f92672">=</span> SBDataset(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/SBD&#39;</span>, image_set<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;train_noval&#39;</span>, 
                      mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;segmentation&#39;</span>, transforms<span style="color:#f92672">=</span>ImLblTransform(True))
im_,lbl_ <span style="color:#f92672">=</span> sbd_train[<span style="color:#ae81ff">0</span>]
fig, ax <span style="color:#f92672">=</span> visualize(im_,lbl_)</code></pre></div>
    </div>
</span>

<img src="index_10_1.png" alt="png"></p>
<h3 id="dataloader">Dataloader</h3>
<p>Now to bring the datasets together for use in training and validation.  If you will be implementing this yourself, note that we used a batch size of 20, which may exceed the memory available on your GPU.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torch.utils <span style="color:#f92672">import</span> data

vocsbd_train <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>ConcatDataset([voc_train, sbd_train])

train_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(vocsbd_train, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>, shuffle<span style="color:#f92672">=</span>True, 
                             num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, pin_memory<span style="color:#f92672">=</span>True, drop_last<span style="color:#f92672">=</span>True)

STEPS_PER_EPOCH <span style="color:#f92672">=</span> len(train_iter)

<span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Steps per Epoch: {}&#39;</span><span style="color:#f92672">.</span>format(STEPS_PER_EPOCH))

val_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(voc_val, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, shuffle<span style="color:#f92672">=</span>False, 
                             num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">12</span>, pin_memory<span style="color:#f92672">=</span>True)</code></pre></div>
    </div>
</span>

<pre><code>Steps per Epoch: 354
</code></pre>
<h3 id="corruptions">Corruptions</h3>
<h4 id="corruptions-to-transform">Corruptions to Transform</h4>
<p>In order to use the machinery in <code>pytorch</code> we wrapped the corruption methods from the <a href="https://pypi.org/project/imagenet-c/" target="_blank" rel="noopener">imagenet-c</a> package in the standard <code>pytorch</code> transform interface. ImageNet-C is part of a collection of work on studying the impacts of corruptions by Dan Hendrycks, Thomas Dietterich, and others. More details can be found on the <a href="https://github.com/hendrycks/robustness" target="_blank" rel="noopener">ImageNet-C Repository</a>.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> imagenet_c <span style="color:#f92672">import</span> corrupt, corruption_tuple
<span style="color:#f92672">from</span> functools <span style="color:#f92672">import</span> partial
<span style="color:#f92672">from</span> itertools <span style="color:#f92672">import</span> product <span style="color:#66d9ef">as</span> iterprod
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image

corr_dict <span style="color:#f92672">=</span> {}
[corr_dict<span style="color:#f92672">.</span>update({p<span style="color:#f92672">.</span>__name__<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;_&#39;</span>)[<span style="color:#ae81ff">0</span>]:n}) <span style="color:#66d9ef">for</span> n,p <span style="color:#f92672">in</span> enumerate(corruption_tuple[:<span style="color:#ae81ff">15</span>])]
<span style="color:#66d9ef">print</span>(corr_dict)

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImLblCorruptTransform</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, severity, corruption_number):
        corrupt_partial <span style="color:#f92672">=</span> partial(corrupt, severity<span style="color:#f92672">=</span>severity, corruption_number<span style="color:#f92672">=</span>corruption_number)
        self<span style="color:#f92672">.</span>joint_transform <span style="color:#f92672">=</span> joint_transforms<span style="color:#f92672">.</span>FixedResize(<span style="color:#ae81ff">224</span>)
        self<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> sz: transforms<span style="color:#f92672">.</span>Compose(
            [
            np<span style="color:#f92672">.</span>array,
            corrupt_partial,
            Image<span style="color:#f92672">.</span>fromarray,
            transforms<span style="color:#f92672">.</span>Resize(sz),
            transforms<span style="color:#f92672">.</span>ToTensor(), 
            transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD),
            ]
        )
        <span style="color:#66d9ef">if</span> severity <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            self<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> sz: transforms<span style="color:#f92672">.</span>Compose(
                [
                transforms<span style="color:#f92672">.</span>ToTensor(), 
                transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD)   
                ]
            )
        
            
    <span style="color:#66d9ef">def</span> __call__(self, img, lbl):
        img, lbl <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>joint_transform(img,lbl)
        W,H <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>size
        sz <span style="color:#f92672">=</span> (H,W)
        img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>transform(sz)(img)
        lbl <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(lbl)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
        lbl <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(lbl)<span style="color:#f92672">.</span>float()
        <span style="color:#66d9ef">return</span> img, lbl</code></pre></div>
    </div>
</span>

<pre><code>{
'gaussian': 0, 'shot': 1, 
'impulse': 2, 'defocus': 3, 
'glass': 4, 'motion': 5, 
'zoom': 6, 'snow': 7, 
'frost': 8, 'fog': 9, 
'brightness': 10, 'contrast': 11, 
'elastic': 12, 'pixelate': 13, 
'jpeg': 14
}
</code></pre>
<h4 id="voc-corruptions-4567">VOC Corruptions 4,5,6,7</h4>
<p>Glass, Motion, Zoom and Snow take a long time for each iteration, so we can gain efficiencies by preprocessing these at all corruption levels.  To do so, use the provided script <code>dump_voc_c.py</code> with the desired corruption number and severity.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> datasets <span style="color:#66d9ef">as</span> dsets
<span style="color:#f92672">from</span> torch.utils.data <span style="color:#f92672">import</span> Dataset, DataLoader
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
MEAN_STD <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#34;mean&#34;</span>:(<span style="color:#ae81ff">0.485</span>, <span style="color:#ae81ff">0.456</span>, <span style="color:#ae81ff">0.406</span>), <span style="color:#e6db74">&#34;std&#34;</span>:(<span style="color:#ae81ff">0.229</span>, <span style="color:#ae81ff">0.224</span>, <span style="color:#ae81ff">0.225</span>)}

    
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">d_4567</span>(Dataset):
    <span style="color:#66d9ef">def</span> __init__(self, cn, sv):
        name <span style="color:#f92672">=</span> corruption_tuple[cn]<span style="color:#f92672">.</span>__name__
        self<span style="color:#f92672">.</span>name <span style="color:#f92672">=</span> name
        self<span style="color:#f92672">.</span>sv <span style="color:#f92672">=</span> sv
        imgdir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;VOC-C/{}/{}/&#39;</span><span style="color:#f92672">.</span>format(name,sv)
        lbldir <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;VOC-C/lbl/&#39;</span>
        
        self<span style="color:#f92672">.</span>img_list <span style="color:#f92672">=</span> [imgdir<span style="color:#f92672">+</span>f <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(imgdir)]
        self<span style="color:#f92672">.</span>lbl_list <span style="color:#f92672">=</span> [lbldir<span style="color:#f92672">+</span>f <span style="color:#66d9ef">for</span> f <span style="color:#f92672">in</span> os<span style="color:#f92672">.</span>listdir(lbldir)]
        self<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose(
            [
            transforms<span style="color:#f92672">.</span>ToTensor(), 
            transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD)   
            ]
        )
        

    <span style="color:#66d9ef">def</span> __len__(self):
        <span style="color:#66d9ef">return</span> len(self<span style="color:#f92672">.</span>img_list)

    <span style="color:#66d9ef">def</span> __getitem__(self, idx):
        img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(self<span style="color:#f92672">.</span>img_list[idx])<span style="color:#f92672">.</span>convert(<span style="color:#e6db74">&#39;RGB&#39;</span>)
        lbl <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>open(self<span style="color:#f92672">.</span>lbl_list[idx])
        img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>transform(img)
        lbl <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(lbl)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
        lbl <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(lbl)<span style="color:#f92672">.</span>float()
        <span style="color:#66d9ef">return</span> img, lbl
    
    <span style="color:#66d9ef">def</span> __str__(self):
        <span style="color:#66d9ef">return</span> <span style="color:#e6db74">&#39;{} @ {}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>name, self<span style="color:#f92672">.</span>sv)
    
    
d_ <span style="color:#f92672">=</span> d_4567(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">4</span>)
<span style="color:#66d9ef">print</span>(d_)
im,lbl <span style="color:#f92672">=</span> d_[<span style="color:#ae81ff">13</span>]
fig, ax <span style="color:#f92672">=</span> visualize(im,lbl)
    </code></pre></div>
    </div>
</span>

<pre><code>motion_blur @ 4
</code></pre>
<p><img src="index_20_1.png" alt="png"></p>
<h4 id="visualize-corruptions">Visualize Corruptions</h4>
<p>Here&rsquo;s what the different corruption levels look like for a subset of the corruptions.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">index <span style="color:#f92672">=</span>  <span style="color:#ae81ff">687</span><span style="color:#75715e">#@param {type:&#34;integer&#34;}</span>
image_set <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;val&#34;</span> <span style="color:#75715e">#@param [&#34;val&#34;, &#34;train&#34;]</span>
<span style="color:#f92672">from</span> imagenet_c <span style="color:#f92672">import</span> corrupt, corruption_tuple
<span style="color:#f92672">from</span> PIL <span style="color:#f92672">import</span> Image
<span style="color:#f92672">import</span> numpy <span style="color:#f92672">as</span> np
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> gridspec

dataset <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, image_set<span style="color:#f92672">=</span>image_set)
im_,lbl_ <span style="color:#f92672">=</span> dataset[index]
w, h <span style="color:#f92672">=</span> im_<span style="color:#f92672">.</span>size
new_h <span style="color:#f92672">=</span> <span style="color:#ae81ff">100</span>
new_low_h <span style="color:#f92672">=</span> <span style="color:#ae81ff">30</span>
new_w <span style="color:#f92672">=</span> <span style="color:#ae81ff">150</span>
ratio <span style="color:#f92672">=</span> w<span style="color:#f92672">/</span>h
s <span style="color:#f92672">=</span> <span style="color:#ae81ff">10</span>
fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(s<span style="color:#f92672">*</span>ratio, s))
gs1 <span style="color:#f92672">=</span> gridspec<span style="color:#f92672">.</span>GridSpec(<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">5</span>)
gs1<span style="color:#f92672">.</span>update(wspace<span style="color:#f92672">=</span><span style="color:#ae81ff">0.05</span>, hspace<span style="color:#f92672">=</span><span style="color:#ae81ff">0.05</span>)
orig_size <span style="color:#f92672">=</span> im_<span style="color:#f92672">.</span>size
i <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">for</span> cn <span style="color:#f92672">in</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">12</span>]:
    <span style="color:#66d9ef">for</span> severity <span style="color:#f92672">in</span> [<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>]:
        corrim <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>fromarray(corrupt(np<span style="color:#f92672">.</span>array(im_<span style="color:#f92672">.</span>resize((<span style="color:#ae81ff">224</span>,<span style="color:#ae81ff">224</span>),<span style="color:#ae81ff">2</span>)), 
                                         severity<span style="color:#f92672">=</span>severity,
                                         corruption_number<span style="color:#f92672">=</span>cn))<span style="color:#f92672">.</span>resize(orig_size)
        <span style="color:#75715e">#corrim2 = corrim.crop((w//2-new_w//2,new_h,w//2+new_w//2,h-new_low_h))</span>
        ax1 <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplot(gs1[i])
        ax1<span style="color:#f92672">.</span>set_xticklabels([])
        ax1<span style="color:#f92672">.</span>set_yticklabels([])
        ax1<span style="color:#f92672">.</span>grid(False)
        ax1<span style="color:#f92672">.</span>imshow(corrim)
        <span style="color:#66d9ef">if</span> severity<span style="color:#f92672">==</span><span style="color:#ae81ff">1</span>:
            corname <span style="color:#f92672">=</span> str(corruption_tuple[cn]<span style="color:#f92672">.</span>__name__)<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;_&#39;</span>)[<span style="color:#ae81ff">0</span>]
            ax1<span style="color:#f92672">.</span>set_ylabel(corname)
        <span style="color:#66d9ef">if</span> cn<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
            ax1<span style="color:#f92672">.</span>set_title(severity)
            
        i<span style="color:#f92672">+=</span><span style="color:#ae81ff">1</span>
    
        
display()</code></pre></div>
    </div>
</span>

<p><img src="index_22_0.png" alt="png"></p>
<h2 id="metrics">Metrics</h2>
<h3 id="running-confusion-matrix">Running Confusion Matrix</h3>
<p>This will allow us to get metrics while running through with batches during training or in aggregate across the entire validation set.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> torch.nn.functional <span style="color:#f92672">as</span> F
<span style="color:#f92672">from</span> sklearn.metrics <span style="color:#f92672">import</span> confusion_matrix <span style="color:#66d9ef">as</span> conf_mat 

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RunningConfusionMatrix</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, num_classes, ignore_class<span style="color:#f92672">=</span>None):
        super(RunningConfusionMatrix, self)<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>num_classes <span style="color:#f92672">=</span> num_classes
        self<span style="color:#f92672">.</span>ignore_class <span style="color:#f92672">=</span> ignore_class
        self<span style="color:#f92672">.</span>reset()

    <span style="color:#66d9ef">def</span> __call__(self, prediction, target):
        prediction <span style="color:#f92672">=</span> prediction<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        target <span style="color:#f92672">=</span> target<span style="color:#f92672">.</span>view(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>ignore_class <span style="color:#f92672">is</span> <span style="color:#f92672">not</span> None:
            prediction <span style="color:#f92672">=</span> prediction[target<span style="color:#f92672">!=</span>self<span style="color:#f92672">.</span>ignore_class]
            target <span style="color:#f92672">=</span> target[target<span style="color:#f92672">!=</span>self<span style="color:#f92672">.</span>ignore_class]
            prediction <span style="color:#f92672">=</span> prediction[prediction<span style="color:#f92672">!=</span>self<span style="color:#f92672">.</span>ignore_class]
            target <span style="color:#f92672">=</span> target[prediction<span style="color:#f92672">!=</span>self<span style="color:#f92672">.</span>ignore_class]
            
        prediction_oh <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>one_hot(prediction, self<span style="color:#f92672">.</span>num_classes)<span style="color:#f92672">.</span>float()
        target_oh <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>one_hot(target<span style="color:#f92672">.</span>long(), self<span style="color:#f92672">.</span>num_classes)<span style="color:#f92672">.</span>float()
        _cm <span style="color:#f92672">=</span> target_oh<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>mm(prediction_oh)<span style="color:#f92672">.</span>long()<span style="color:#f92672">.</span>cpu()
        self<span style="color:#f92672">.</span>cm <span style="color:#f92672">+=</span> _cm<span style="color:#f92672">.</span>cpu()
    
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">acc</span>(self):
        <span style="color:#66d9ef">return</span> self<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>diag()<span style="color:#f92672">/</span>self<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>sum(<span style="color:#ae81ff">0</span>)
        
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">iou</span>(self):
        tp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>diag()
        fp <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>sum(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">-</span> tp
        fn <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cm<span style="color:#f92672">.</span>sum(<span style="color:#ae81ff">1</span>) <span style="color:#f92672">-</span> tp
        <span style="color:#66d9ef">return</span> tp<span style="color:#f92672">/</span>(tp<span style="color:#f92672">+</span>fp<span style="color:#f92672">+</span>fn)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
        self<span style="color:#f92672">.</span>cm <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(self<span style="color:#f92672">.</span>num_classes, self<span style="color:#f92672">.</span>num_classes)</code></pre></div>
    </div>
</span>

<h2 id="experiment">Experiment</h2>
<h3 id="trainer">Trainer</h3>
<p>Here is a configurable implementation of a semantic segmentation experiment.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision <span style="color:#f92672">import</span> utils
<span style="color:#f92672">from</span> IPython.display <span style="color:#f92672">import</span> display, clear_output
<span style="color:#f92672">from</span> tqdm.notebook <span style="color:#f92672">import</span> tqdm
<span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">SemanticSegmentation</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, config):
        
        self<span style="color:#f92672">.</span>cuda <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;cuda&#39;</span>]
        self<span style="color:#f92672">.</span>one_hot <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;one_hot&#39;</span>]
        self<span style="color:#f92672">.</span>device <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;cuda&#39;</span> <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>cuda <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;cpu&#39;</span>
        self<span style="color:#f92672">.</span>confusion_matrix <span style="color:#f92672">=</span> RunningConfusionMatrix(config[<span style="color:#e6db74">&#39;num_classes&#39;</span>], <span style="color:#ae81ff">255</span>)
        
        model <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
        criterion <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;criterion&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>config[<span style="color:#e6db74">&#39;criterion&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
        
        self<span style="color:#f92672">.</span>optimizer <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;optimizer&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>]([
           {<span style="color:#e6db74">&#39;params&#39;</span>:model<span style="color:#f92672">.</span>backbone<span style="color:#f92672">.</span>parameters()},
           {<span style="color:#e6db74">&#39;params&#39;</span>:model<span style="color:#f92672">.</span>classifier<span style="color:#f92672">.</span>parameters(), <span style="color:#e6db74">&#39;lr&#39;</span>:config[<span style="color:#e6db74">&#39;optimizer&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>][<span style="color:#e6db74">&#39;lr&#39;</span>]<span style="color:#f92672">*</span><span style="color:#ae81ff">10</span>},
        ],<span style="color:#f92672">**</span>config[<span style="color:#e6db74">&#39;optimizer&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
        self<span style="color:#f92672">.</span>train_iter <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;train_iter&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>config[<span style="color:#e6db74">&#39;train_iter&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
        self<span style="color:#f92672">.</span>val_iter <span style="color:#f92672">=</span> config[<span style="color:#e6db74">&#39;val_iter&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>config[<span style="color:#e6db74">&#39;val_iter&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
        
        
        
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>cuda:
            <span style="color:#75715e">#self.model = DataParallelModel(model.to(self.device), device_ids=[0,1])</span>
            <span style="color:#75715e">#self.criterion = DataParallelCriterion(criterion.to(self.device), device_ids=[0,1])</span>
            self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>DataParallel(model, device_ids<span style="color:#f92672">=</span>[<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>])<span style="color:#f92672">.</span>cuda()
            self<span style="color:#f92672">.</span>criterion <span style="color:#f92672">=</span> criterion
        <span style="color:#66d9ef">else</span>:
            self<span style="color:#f92672">.</span>model <span style="color:#f92672">=</span> model
            self<span style="color:#f92672">.</span>criterion <span style="color:#f92672">=</span> criterion
        
        self<span style="color:#f92672">.</span>steps <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>epoch_n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>config <span style="color:#f92672">=</span> config
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">evaluator</span>(self):
        <span style="color:#66d9ef">pass</span>
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">step</span>(self, input, target, oh_target):
        name <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Train&#39;</span> <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>training <span style="color:#66d9ef">else</span> <span style="color:#e6db74">&#39;Val&#39;</span>
        output <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>model(input)
        pred <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)
        self<span style="color:#f92672">.</span>confusion_matrix(pred, target)
        iou <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>confusion_matrix<span style="color:#f92672">.</span>iou
        miou <span style="color:#f92672">=</span> iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(iou)]<span style="color:#f92672">.</span>mean()
        <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>training:
            self<span style="color:#f92672">.</span>confusion_matrix<span style="color:#f92672">.</span>reset()
            loss <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>criterion(output, oh_target <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>one_hot <span style="color:#66d9ef">else</span> target<span style="color:#f92672">.</span>long())<span style="color:#f92672">.</span>mean()
            self<span style="color:#f92672">.</span>optimizer<span style="color:#f92672">.</span>zero_grad()
            loss<span style="color:#f92672">.</span>backward()
            self<span style="color:#f92672">.</span>optimizer<span style="color:#f92672">.</span>step()
            self<span style="color:#f92672">.</span>steps <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
            _loss <span style="color:#f92672">=</span> loss<span style="color:#f92672">.</span>item()
        <span style="color:#66d9ef">else</span>:
            _loss <span style="color:#f92672">=</span>  <span style="color:#ae81ff">0</span>
        self<span style="color:#f92672">.</span>tbar<span style="color:#f92672">.</span>set_description(<span style="color:#e6db74">&#39;[{} - {}] Loss: {:.3f}, mIOU: {:.3f}&#39;</span><span style="color:#f92672">.</span>format(self<span style="color:#f92672">.</span>epoch_n, name, _loss, miou))
        <span style="color:#66d9ef">return</span> pred<span style="color:#f92672">.</span>cpu()
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">epoch</span>(self, data_iter):
        self<span style="color:#f92672">.</span>tbar <span style="color:#f92672">=</span> tqdm(data_iter)
        <span style="color:#66d9ef">for</span> input, target <span style="color:#f92672">in</span> self<span style="color:#f92672">.</span>tbar:
            _target <span style="color:#f92672">=</span> target<span style="color:#f92672">.</span>clone()
            _target[target<span style="color:#f92672">==</span><span style="color:#ae81ff">255</span>] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
            oh_target <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>functional<span style="color:#f92672">.</span>one_hot(_target<span style="color:#f92672">.</span>long(),<span style="color:#ae81ff">21</span>)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>float()
            pred <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>step(input<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>device), 
                               target<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>device), 
                               oh_target<span style="color:#f92672">.</span>to(self<span style="color:#f92672">.</span>device))

    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">train</span>(self, num_epochs, lr_sched<span style="color:#f92672">=</span>True):
        <span style="color:#66d9ef">if</span> lr_sched:
            poly <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> step: (<span style="color:#ae81ff">1</span> <span style="color:#f92672">-</span> step<span style="color:#f92672">/</span>num_epochs)<span style="color:#f92672">**</span><span style="color:#ae81ff">0.9</span>
        <span style="color:#66d9ef">else</span>:
            poly <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> step: <span style="color:#ae81ff">1</span> 
        self<span style="color:#f92672">.</span>lr_scheduler <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>lr_scheduler<span style="color:#f92672">.</span>LambdaLR(self<span style="color:#f92672">.</span>optimizer, lr_lambda<span style="color:#f92672">=</span>poly)
        <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(num_epochs):
            self<span style="color:#f92672">.</span>epoch_n <span style="color:#f92672">=</span> n
            self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>train()
            self<span style="color:#f92672">.</span>epoch(self<span style="color:#f92672">.</span>train_iter)
            <span style="color:#66d9ef">if</span> self<span style="color:#f92672">.</span>config[<span style="color:#e6db74">&#39;validate_while_train&#39;</span>]:
                self<span style="color:#f92672">.</span>validate()
            self<span style="color:#f92672">.</span>lr_scheduler<span style="color:#f92672">.</span>step()
            
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">validate</span>(self):
        self<span style="color:#f92672">.</span>confusion_matrix<span style="color:#f92672">.</span>reset()
        self<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>eval()
        self<span style="color:#f92672">.</span>epoch(self<span style="color:#f92672">.</span>val_iter)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">visualize</span>(self, input, target, pred):
        fig, ax <span style="color:#f92672">=</span> visualize(input[<span style="color:#ae81ff">0</span>], target[<span style="color:#ae81ff">0</span>], pred[<span style="color:#ae81ff">0</span>])</code></pre></div>
    </div>
</span>

<h2 id="models">Models</h2>
<p>Below we prepare three versions of the DeepLab v3+ with ResNet50 backbone: vanilla, Implicit Background Estimation (IBE), and Sigmoid Cross Entropy Implicit Background Estimation (SCrIBE).  Since the  models are trained from an ImageNet pretrained ResNet50, the appropriate layers are replaced and wrapped in an <code>nn.Module</code>. We then train each model using the previously introduced configurable experiment.</p>
<h3 id="deeplabv3">DeepLabV3+</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision.models.segmentation <span style="color:#f92672">import</span> deeplabv3_resnet50
<span style="color:#f92672">from</span> torchvision.models <span style="color:#f92672">import</span> resnet50
<span style="color:#f92672">from</span> torchvision.models._utils <span style="color:#f92672">import</span> IntermediateLayerGetter
<span style="color:#f92672">from</span> torch <span style="color:#f92672">import</span> nn

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DLv3_ResNet50</span>(nn<span style="color:#f92672">.</span>Module):
    <span style="color:#66d9ef">def</span> __init__(self, num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>):
        super(DLv3_ResNet50, self)<span style="color:#f92672">.</span>__init__()
        model <span style="color:#f92672">=</span> deeplabv3_resnet50(num_classes <span style="color:#f92672">=</span> num_classes)
        backbone <span style="color:#f92672">=</span> resnet50(pretrained<span style="color:#f92672">=</span>True, replace_stride_with_dilation<span style="color:#f92672">=</span>[False, True, True])
        return_layers <span style="color:#f92672">=</span> {<span style="color:#e6db74">&#39;layer4&#39;</span>: <span style="color:#e6db74">&#39;out&#39;</span>}
        model<span style="color:#f92672">.</span>backbone <span style="color:#f92672">=</span> IntermediateLayerGetter(backbone, return_layers<span style="color:#f92672">=</span>return_layers)
        self<span style="color:#f92672">.</span>backbone <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>backbone
        self<span style="color:#f92672">.</span>classifier <span style="color:#f92672">=</span> model<span style="color:#f92672">.</span>classifier
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x):
        input_shape <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]
        features <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>backbone(x)
        x <span style="color:#f92672">=</span> features[<span style="color:#e6db74">&#34;out&#34;</span>]
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>classifier(x)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>interpolate(x, size<span style="color:#f92672">=</span>input_shape, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bilinear&#39;</span>, align_corners<span style="color:#f92672">=</span>False)
        <span style="color:#66d9ef">return</span> x
    
    
ns_config <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;num_classes&#39;</span>:<span style="color:#ae81ff">21</span>,
    <span style="color:#e6db74">&#39;one_hot&#39;</span>:False,
    <span style="color:#e6db74">&#39;cuda&#39;</span>:True,
    <span style="color:#e6db74">&#39;validate_while_train&#39;</span>:True,
    <span style="color:#e6db74">&#39;model&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:DLv3_ResNet50,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;num_classes&#39;</span>:<span style="color:#ae81ff">21</span>,
        },
    },
    <span style="color:#e6db74">&#39;criterion&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:nn<span style="color:#f92672">.</span>CrossEntropyLoss,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;ignore_index&#39;</span>:<span style="color:#ae81ff">255</span>,
        },
    },
    <span style="color:#e6db74">&#39;optimizer&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>: torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;lr&#39;</span>:<span style="color:#ae81ff">0.01</span>,
            <span style="color:#e6db74">&#39;momentum&#39;</span>:<span style="color:#ae81ff">0.9</span>,
            <span style="color:#e6db74">&#39;weight_decay&#39;</span>:<span style="color:#ae81ff">5e-5</span>,
            <span style="color:#e6db74">&#39;nesterov&#39;</span>:False
        },
    },
    <span style="color:#e6db74">&#39;train_iter&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:data<span style="color:#f92672">.</span>DataLoader,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;dataset&#39;</span>:vocsbd_train,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>:<span style="color:#ae81ff">30</span>,
            <span style="color:#e6db74">&#39;shuffle&#39;</span>:True,
            <span style="color:#e6db74">&#39;num_workers&#39;</span>:<span style="color:#ae81ff">12</span>,
            <span style="color:#e6db74">&#39;pin_memory&#39;</span>:True,
            <span style="color:#e6db74">&#39;drop_last&#39;</span>:True,
        }
    },
    <span style="color:#e6db74">&#39;val_iter&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:data<span style="color:#f92672">.</span>DataLoader,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;dataset&#39;</span>:voc_val,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>:<span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#39;shuffle&#39;</span>:False,
            <span style="color:#e6db74">&#39;num_workers&#39;</span>:<span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#39;pin_memory&#39;</span>:False,
            <span style="color:#e6db74">&#39;drop_last&#39;</span>:False,
        }
    }
}

pth <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;data/DLv3_ResNet50.pth&#39;</span>
<span style="color:#66d9ef">if</span>  os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(pth):
    no_scribe_model <span style="color:#f92672">=</span> ns_config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>ns_config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
    no_scribe_model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(pth))
<span style="color:#66d9ef">else</span>:
    no_scribe_experiment <span style="color:#f92672">=</span> SemanticSegmentation(ns_config)
    no_scribe_experiment<span style="color:#f92672">.</span>train(<span style="color:#ae81ff">50</span>, True)
    no_scribe_model <span style="color:#f92672">=</span> no_scribe_experiment<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>module
    torch<span style="color:#f92672">.</span>save(no_scribe_model<span style="color:#f92672">.</span>state_dict(), pth)
    no_scribe_experiment<span style="color:#f92672">.</span>validate()</code></pre></div>
    </div>
</span>

<h3 id="deeplabv3ibe">DeepLabV3+IBE</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DLv3_ResNet50_IBE</span>(DLv3_ResNet50):
    <span style="color:#66d9ef">def</span> __init__(self, num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>):
        super(DLv3_ResNet50_IBE, self)<span style="color:#f92672">.</span>__init__(num_classes<span style="color:#f92672">=</span>num_classes)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x):
        input_shape <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]
        features <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>backbone(x)
        x <span style="color:#f92672">=</span> features[<span style="color:#e6db74">&#34;out&#34;</span>]
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>classifier(x)
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([<span style="color:#f92672">-</span>torch<span style="color:#f92672">.</span>logsumexp(x,<span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True),x],<span style="color:#ae81ff">1</span>)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>interpolate(x, size<span style="color:#f92672">=</span>input_shape, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bilinear&#39;</span>, align_corners<span style="color:#f92672">=</span>False)
        <span style="color:#66d9ef">return</span> x
    
i_config <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;num_classes&#39;</span>:<span style="color:#ae81ff">21</span>,
    <span style="color:#e6db74">&#39;one_hot&#39;</span>:False,
    <span style="color:#e6db74">&#39;cuda&#39;</span>:True,
    <span style="color:#e6db74">&#39;validate_while_train&#39;</span>:True,
    <span style="color:#e6db74">&#39;model&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:DLv3_ResNet50_IBE,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;num_classes&#39;</span>:<span style="color:#ae81ff">20</span>,
        },
    },
    <span style="color:#e6db74">&#39;criterion&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:nn<span style="color:#f92672">.</span>CrossEntropyLoss,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;ignore_index&#39;</span>:<span style="color:#ae81ff">255</span>,
        },
    },
    <span style="color:#e6db74">&#39;optimizer&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>: torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;lr&#39;</span>:<span style="color:#ae81ff">0.01</span>,
            <span style="color:#e6db74">&#39;momentum&#39;</span>:<span style="color:#ae81ff">0.9</span>,
            <span style="color:#e6db74">&#39;weight_decay&#39;</span>:<span style="color:#ae81ff">5e-5</span>,
            <span style="color:#e6db74">&#39;nesterov&#39;</span>:False
        }
    },
    <span style="color:#e6db74">&#39;train_iter&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:data<span style="color:#f92672">.</span>DataLoader,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;dataset&#39;</span>:vocsbd_train,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>:<span style="color:#ae81ff">30</span>,
            <span style="color:#e6db74">&#39;shuffle&#39;</span>:True,
            <span style="color:#e6db74">&#39;num_workers&#39;</span>:<span style="color:#ae81ff">12</span>,
            <span style="color:#e6db74">&#39;pin_memory&#39;</span>:True,
            <span style="color:#e6db74">&#39;drop_last&#39;</span>:True,
        }
    },
    <span style="color:#e6db74">&#39;val_iter&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:data<span style="color:#f92672">.</span>DataLoader,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;dataset&#39;</span>:voc_val,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>:<span style="color:#ae81ff">5</span>,
            <span style="color:#e6db74">&#39;shuffle&#39;</span>:False,
            <span style="color:#e6db74">&#39;num_workers&#39;</span>:<span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#39;pin_memory&#39;</span>:False,
            <span style="color:#e6db74">&#39;drop_last&#39;</span>:False,
        }
    }
}

pth <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;data/DLv3_IBE.pth&#39;</span>
<span style="color:#66d9ef">if</span>  os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(pth):
    ibe_model <span style="color:#f92672">=</span> i_config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>i_config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
    ibe_model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(pth))
<span style="color:#66d9ef">else</span>:
    ibe_experiment <span style="color:#f92672">=</span> SemanticSegmentation(i_config)
    ibe_experiment<span style="color:#f92672">.</span>train(<span style="color:#ae81ff">50</span>, True)
    ibe_model <span style="color:#f92672">=</span> ibe_experiment<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>module
    torch<span style="color:#f92672">.</span>save(ibe_model<span style="color:#f92672">.</span>state_dict(), pth)
    ibe_experiment<span style="color:#f92672">.</span>validate()
    
    </code></pre></div>
    </div>
</span>

<h3 id="deeplabv3scribe">DeepLabV3+ScrIBE</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">DLv3_ResNet50_SCrIBE</span>(DLv3_ResNet50):
    <span style="color:#66d9ef">def</span> __init__(self, num_classes<span style="color:#f92672">=</span><span style="color:#ae81ff">20</span>):
        super(DLv3_ResNet50_SCrIBE, self)<span style="color:#f92672">.</span>__init__(num_classes<span style="color:#f92672">=</span>num_classes)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">forward</span>(self,x):
        input_shape <span style="color:#f92672">=</span> x<span style="color:#f92672">.</span>shape[<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span>:]
        _x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>backbone(x)
        x <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>classifier(_x[<span style="color:#e6db74">&#34;out&#34;</span>])
        x <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([<span style="color:#f92672">-</span>torch<span style="color:#f92672">.</span>logsumexp(x,<span style="color:#ae81ff">1</span>, keepdim<span style="color:#f92672">=</span>True),x],<span style="color:#ae81ff">1</span>)
        x <span style="color:#f92672">=</span> F<span style="color:#f92672">.</span>interpolate(x, size<span style="color:#f92672">=</span>input_shape, mode<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bilinear&#39;</span>, align_corners<span style="color:#f92672">=</span>False)
        <span style="color:#66d9ef">return</span> x
    
    
s_config <span style="color:#f92672">=</span> {
    <span style="color:#e6db74">&#39;num_classes&#39;</span>:<span style="color:#ae81ff">21</span>,
    <span style="color:#e6db74">&#39;one_hot&#39;</span>:True,
    <span style="color:#e6db74">&#39;cuda&#39;</span>:True,
    <span style="color:#e6db74">&#39;validate_while_train&#39;</span>:True,
    <span style="color:#e6db74">&#39;model&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:DLv3_ResNet50_SCrIBE,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;num_classes&#39;</span>:<span style="color:#ae81ff">20</span>,
        },
    },
    <span style="color:#e6db74">&#39;criterion&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:nn<span style="color:#f92672">.</span>BCEWithLogitsLoss,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
        },
    },
    <span style="color:#e6db74">&#39;optimizer&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>: torch<span style="color:#f92672">.</span>optim<span style="color:#f92672">.</span>SGD,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;lr&#39;</span>:<span style="color:#ae81ff">0.01</span>,
            <span style="color:#e6db74">&#39;momentum&#39;</span>:<span style="color:#ae81ff">0.9</span>,
            <span style="color:#e6db74">&#39;weight_decay&#39;</span>:<span style="color:#ae81ff">5e-5</span>,
            <span style="color:#e6db74">&#39;nesterov&#39;</span>:False
        }
    },
    <span style="color:#e6db74">&#39;train_iter&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:data<span style="color:#f92672">.</span>DataLoader,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;dataset&#39;</span>:vocsbd_train,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>:<span style="color:#ae81ff">30</span>,
            <span style="color:#e6db74">&#39;shuffle&#39;</span>:True,
            <span style="color:#e6db74">&#39;num_workers&#39;</span>:<span style="color:#ae81ff">12</span>,
            <span style="color:#e6db74">&#39;pin_memory&#39;</span>:True,
            <span style="color:#e6db74">&#39;drop_last&#39;</span>:True,
        }
    },
    <span style="color:#e6db74">&#39;val_iter&#39;</span>:{
        <span style="color:#e6db74">&#39;class&#39;</span>:data<span style="color:#f92672">.</span>DataLoader,
        <span style="color:#e6db74">&#39;kwargs&#39;</span>:{
            <span style="color:#e6db74">&#39;dataset&#39;</span>:voc_val,
            <span style="color:#e6db74">&#39;batch_size&#39;</span>:<span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#39;shuffle&#39;</span>:False,
            <span style="color:#e6db74">&#39;num_workers&#39;</span>:<span style="color:#ae81ff">1</span>,
            <span style="color:#e6db74">&#39;pin_memory&#39;</span>:False,
            <span style="color:#e6db74">&#39;drop_last&#39;</span>:False,
        }
    }
}

pth <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;data/DLv3_SCrIBE.pth&#39;</span>
<span style="color:#66d9ef">if</span>  os<span style="color:#f92672">.</span>path<span style="color:#f92672">.</span>isfile(pth):
    scribe_model <span style="color:#f92672">=</span> s_config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;class&#39;</span>](<span style="color:#f92672">**</span>s_config[<span style="color:#e6db74">&#39;model&#39;</span>][<span style="color:#e6db74">&#39;kwargs&#39;</span>])
    scribe_model<span style="color:#f92672">.</span>load_state_dict(torch<span style="color:#f92672">.</span>load(pth))
<span style="color:#66d9ef">else</span>:
    scribe_experiment <span style="color:#f92672">=</span> SemanticSegmentation(s_config)
    scribe_experiment<span style="color:#f92672">.</span>train(<span style="color:#ae81ff">50</span>, True)
    scribe_model <span style="color:#f92672">=</span> scribe_experiment<span style="color:#f92672">.</span>model<span style="color:#f92672">.</span>module
    torch<span style="color:#f92672">.</span>save(scribe_model<span style="color:#f92672">.</span>state_dict(), pth)
    scribe_experiment<span style="color:#f92672">.</span>validate()
    </code></pre></div>
    </div>
</span>

<h2 id="representation-metrics">Representation Metrics</h2>
<h3 id="running-logit-tracker">Running Logit Tracker</h3>
<p>Much like the Running Confusion Matrix, we will also track the logits or pre-softmax model outputs over a run of batched iterations for later analysis.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">RunningLogitTracker</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, num_classes, ignore_class<span style="color:#f92672">=</span>None):
        super(RunningLogitTracker, self)<span style="color:#f92672">.</span>__init__()
        self<span style="color:#f92672">.</span>num_classes <span style="color:#f92672">=</span> num_classes
        self<span style="color:#f92672">.</span>ignore_class <span style="color:#f92672">=</span> ignore_class
        self<span style="color:#f92672">.</span>reset()

    <span style="color:#66d9ef">def</span> __call__(self, output):
        output <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>reshape(<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,self<span style="color:#f92672">.</span>num_classes)
        _pred <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)
        <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>num_classes):
            x <span style="color:#f92672">=</span> output[_pred<span style="color:#f92672">==</span>n,:]<span style="color:#f92672">.</span>detach()
            self<span style="color:#f92672">.</span>counts[n] <span style="color:#f92672">+=</span> x<span style="color:#f92672">.</span>size(<span style="color:#ae81ff">0</span>)
            self<span style="color:#f92672">.</span>sums[n] <span style="color:#f92672">+=</span> x<span style="color:#f92672">.</span>sum(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>cpu()
            self<span style="color:#f92672">.</span>sumsqs[n] <span style="color:#f92672">+=</span> x<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>mm(x)<span style="color:#f92672">.</span>cpu()
        
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dist</span>(self,x,y):
        <span style="color:#66d9ef">return</span> (x<span style="color:#f92672">-</span>y)<span style="color:#f92672">.</span>pow(<span style="color:#ae81ff">2</span>)<span style="color:#f92672">.</span>sum()<span style="color:#f92672">.</span>sqrt()
    
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dm</span>(self):
        _dm <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(self<span style="color:#f92672">.</span>num_classes, self<span style="color:#f92672">.</span>num_classes)
        mn <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mean
        <span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">0</span>,self<span style="color:#f92672">.</span>num_classes):
            <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(i,self<span style="color:#f92672">.</span>num_classes):
                _dm[i,j] <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>dist(mn[i], mn[j])
                _dm[j,i] <span style="color:#f92672">=</span> _dm[i,j]
        <span style="color:#66d9ef">return</span> _dm
        
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">mean</span>(self):
        out <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sums<span style="color:#f92672">/</span>self<span style="color:#f92672">.</span>counts<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>)
        out[out<span style="color:#f92672">!=</span>out] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
        <span style="color:#66d9ef">return</span> out
    
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cov</span>(self):
        covs <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>num_classes):
            mn <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>mean[n]<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>)
            sq <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>sumsqs[n]
            _cov <span style="color:#f92672">=</span> (sq <span style="color:#f92672">-</span> mn<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>mm(mn))<span style="color:#f92672">/</span>self<span style="color:#f92672">.</span>counts[n]
            _cov[_cov<span style="color:#f92672">!=</span>_cov] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
            covs<span style="color:#f92672">.</span>append(_cov)
        <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>stack(covs,<span style="color:#ae81ff">0</span>)
    
    <span style="color:#a6e22e">@property</span>
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">cor</span>(self):
        covs <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>cov
        cors <span style="color:#f92672">=</span> []
        <span style="color:#66d9ef">for</span> n <span style="color:#f92672">in</span> range(self<span style="color:#f92672">.</span>num_classes):
            S <span style="color:#f92672">=</span> covs[n]
            Dinv <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>inverse(S<span style="color:#f92672">.</span>diag()<span style="color:#f92672">.</span>diag()<span style="color:#f92672">.</span>sqrt())
            R <span style="color:#f92672">=</span> Dinv<span style="color:#f92672">.</span>mm(S)<span style="color:#f92672">.</span>mm(Dinv)
            cors<span style="color:#f92672">.</span>append(R)
        <span style="color:#66d9ef">return</span> torch<span style="color:#f92672">.</span>stack(cors,<span style="color:#ae81ff">0</span>)
    
    <span style="color:#66d9ef">def</span> <span style="color:#a6e22e">reset</span>(self):
        self<span style="color:#f92672">.</span>counts <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(self<span style="color:#f92672">.</span>num_classes) 
        self<span style="color:#f92672">.</span>sums <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(self<span style="color:#f92672">.</span>num_classes, self<span style="color:#f92672">.</span>num_classes)
        self<span style="color:#f92672">.</span>sumsqs <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>zeros(self<span style="color:#f92672">.</span>num_classes, self<span style="color:#f92672">.</span>num_classes, self<span style="color:#f92672">.</span>num_classes)</code></pre></div>
    </div>
</span>

<h3 id="run-over-all-corruptions-and-levels">Run over all Corruptions and Levels</h3>
<p>Here we measure the performance of each model for each corruption at each level.  This also takes a while, but has some progress saving built in.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> gc
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd


batch <span style="color:#f92672">=</span> <span style="color:#ae81ff">20</span>

nm <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;data/DistCombined.pkl&#39;</span>

scribe_model <span style="color:#f92672">=</span> scribe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>)
ibe_model <span style="color:#f92672">=</span> ibe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>)
no_scribe_model <span style="color:#f92672">=</span> no_scribe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>)

scribe_model<span style="color:#f92672">.</span>eval()
ibe_model<span style="color:#f92672">.</span>eval()
no_scribe_model<span style="color:#f92672">.</span>eval()

<span style="color:#66d9ef">try</span>:
    dist_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_pickle(nm)<span style="color:#f92672">.</span>drop_duplicates()
    lgst_cn <span style="color:#f92672">=</span> dist_df[<span style="color:#e6db74">&#39;corruption_number&#39;</span>]<span style="color:#f92672">.</span>max()
    lgst_sv <span style="color:#f92672">=</span> dist_df[dist_df[<span style="color:#e6db74">&#39;corruption_number&#39;</span>]<span style="color:#f92672">==</span>lgst_cn][<span style="color:#e6db74">&#39;Severity&#39;</span>]<span style="color:#f92672">.</span>max()
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Restarting from {}@{}&#39;</span><span style="color:#f92672">.</span>format(lgst_cn, lgst_sv))
    dist_data <span style="color:#f92672">=</span> dist_df<span style="color:#f92672">.</span>to_dict(<span style="color:#e6db74">&#39;records&#39;</span>)
    flag <span style="color:#f92672">=</span> False 
<span style="color:#66d9ef">except</span>:
    <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;New Run!&#39;</span>)
    lgst_cn <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    lgst_sv <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
    dist_data <span style="color:#f92672">=</span> []
    flag <span style="color:#f92672">=</span> False 


<span style="color:#66d9ef">for</span> cn <span style="color:#f92672">in</span> range(lgst_cn,<span style="color:#ae81ff">15</span>):
    corruption_name <span style="color:#f92672">=</span> corruption_tuple[cn]<span style="color:#f92672">.</span>__name__
    <span style="color:#66d9ef">for</span> sv <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">6</span>):
        <span style="color:#66d9ef">if</span> sv<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> flag:
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Case 1: Skipping {}@{}&#39;</span><span style="color:#f92672">.</span>format(cn, sv))
            <span style="color:#66d9ef">continue</span>
        <span style="color:#66d9ef">if</span> cn <span style="color:#f92672">!=</span> lgst_cn: 
            lgst_sv<span style="color:#f92672">=-</span><span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> sv <span style="color:#f92672">&lt;</span> lgst_sv: 
            <span style="color:#66d9ef">print</span>(<span style="color:#e6db74">&#39;Case 2: Skipping {}@{}&#39;</span><span style="color:#f92672">.</span>format(cn, sv))
            <span style="color:#66d9ef">continue</span>
        s_cm <span style="color:#f92672">=</span> RunningConfusionMatrix(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
        i_cm <span style="color:#f92672">=</span> RunningConfusionMatrix(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
        n_cm <span style="color:#f92672">=</span> RunningConfusionMatrix(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
        s_lt <span style="color:#f92672">=</span> RunningLogitTracker(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
        i_lt <span style="color:#f92672">=</span> RunningLogitTracker(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
        n_lt <span style="color:#f92672">=</span> RunningLogitTracker(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)

        <span style="color:#66d9ef">if</span> cn <span style="color:#f92672">in</span> [<span style="color:#ae81ff">4</span>,<span style="color:#ae81ff">5</span>,<span style="color:#ae81ff">6</span>,<span style="color:#ae81ff">7</span>]:
            corr_val <span style="color:#f92672">=</span> d_4567(cn,sv)
        <span style="color:#66d9ef">else</span>:
            corr_val <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, 
                                        transforms<span style="color:#f92672">=</span>ImLblCorruptTransform(sv,cn), 
                                        image_set<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val&#39;</span>)

        corr_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(corr_val, batch_size<span style="color:#f92672">=</span>batch, shuffle<span style="color:#f92672">=</span>False, num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pin_memory<span style="color:#f92672">=</span>True)
        pbar <span style="color:#f92672">=</span> tqdm(corr_iter, position<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, leave<span style="color:#f92672">=</span>True)
        <span style="color:#66d9ef">for</span> im,lbl <span style="color:#f92672">in</span> pbar:
            s_output <span style="color:#f92672">=</span> scribe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
            i_output <span style="color:#f92672">=</span> ibe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
            n_output <span style="color:#f92672">=</span> no_scribe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>))

            s_pred <span style="color:#f92672">=</span> s_output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)
            i_pred <span style="color:#f92672">=</span> i_output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)
            n_pred <span style="color:#f92672">=</span> n_output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)

            s_cm(s_pred, lbl<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
            i_cm(i_pred, lbl<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
            n_cm(n_pred, lbl<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>))

            s_iou <span style="color:#f92672">=</span> s_cm<span style="color:#f92672">.</span>iou
            s_miou <span style="color:#f92672">=</span> s_iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(s_iou)]<span style="color:#f92672">.</span>mean()
            i_iou <span style="color:#f92672">=</span> i_cm<span style="color:#f92672">.</span>iou
            i_miou <span style="color:#f92672">=</span> i_iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(i_iou)]<span style="color:#f92672">.</span>mean()
            n_iou <span style="color:#f92672">=</span> n_cm<span style="color:#f92672">.</span>iou
            n_miou <span style="color:#f92672">=</span> n_iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(n_iou)]<span style="color:#f92672">.</span>mean()

            s_lt(s_output)
            i_lt(i_output)
            n_lt(n_output)


            pbar<span style="color:#f92672">.</span>set_description(<span style="color:#e6db74">&#39;{}@{} S/I/B: {:.3f} / {:.3f} / {:.3f}&#39;</span><span style="color:#f92672">.</span>format(cn, sv, s_miou,i_miou,n_miou))
            
        s_mn <span style="color:#f92672">=</span> s_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()
        i_mn <span style="color:#f92672">=</span> i_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()
        n_mn <span style="color:#f92672">=</span> n_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()

        s_r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(np<span style="color:#f92672">.</span>diagonal(s_mn)[<span style="color:#ae81ff">1</span>:]<span style="color:#f92672">-</span>s_mn[<span style="color:#ae81ff">1</span>:,<span style="color:#ae81ff">0</span>])
        i_r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(np<span style="color:#f92672">.</span>diagonal(i_mn)[<span style="color:#ae81ff">1</span>:]<span style="color:#f92672">-</span>i_mn[<span style="color:#ae81ff">1</span>:,<span style="color:#ae81ff">0</span>])
        n_r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>mean(np<span style="color:#f92672">.</span>diagonal(n_mn)[<span style="color:#ae81ff">1</span>:]<span style="color:#f92672">-</span>n_mn[<span style="color:#ae81ff">1</span>:,<span style="color:#ae81ff">0</span>])
        dist_data<span style="color:#f92672">.</span>append(
                    {
                        <span style="color:#e6db74">&#39;Model&#39;</span>:<span style="color:#e6db74">&#39;ScrIBE&#39;</span>,
                        <span style="color:#e6db74">&#39;Corruption&#39;</span>:corruption_name,
                        <span style="color:#e6db74">&#39;corruption_number&#39;</span>:cn,
                        <span style="color:#e6db74">&#39;Severity&#39;</span>:sv,
                        <span style="color:#e6db74">&#39;mIOU&#39;</span>:s_miou<span style="color:#f92672">.</span>item(),
                        <span style="color:#e6db74">&#39;Distance&#39;</span>:s_r
                    }
        )
        dist_data<span style="color:#f92672">.</span>append(
                    {
                        <span style="color:#e6db74">&#39;Model&#39;</span>:<span style="color:#e6db74">&#39;IBE&#39;</span>,
                        <span style="color:#e6db74">&#39;Corruption&#39;</span>:corruption_name,
                        <span style="color:#e6db74">&#39;corruption_number&#39;</span>:cn,
                        <span style="color:#e6db74">&#39;Severity&#39;</span>:sv,
                        <span style="color:#e6db74">&#39;mIOU&#39;</span>:i_miou<span style="color:#f92672">.</span>item(),
                        <span style="color:#e6db74">&#39;Distance&#39;</span>:i_r
                    }
        )
        dist_data<span style="color:#f92672">.</span>append(
                    {
                        <span style="color:#e6db74">&#39;Model&#39;</span>:<span style="color:#e6db74">&#39;Baseline&#39;</span>,
                        <span style="color:#e6db74">&#39;Corruption&#39;</span>:corruption_name,
                        <span style="color:#e6db74">&#39;corruption_number&#39;</span>:cn,
                        <span style="color:#e6db74">&#39;Severity&#39;</span>:sv,
                        <span style="color:#e6db74">&#39;mIOU&#39;</span>:n_miou<span style="color:#f92672">.</span>item(),
                        <span style="color:#e6db74">&#39;Distance&#39;</span>:n_r
                    }
        )

        dist_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(dist_data)
        dist_df<span style="color:#f92672">.</span>to_pickle(nm)
        flag <span style="color:#f92672">=</span> True</code></pre></div>
    </div>
</span>

<pre><code>Restarting from 14@5
Case 2: Skipping 14@0
Case 2: Skipping 14@1
Case 2: Skipping 14@2
Case 2: Skipping 14@3
Case 2: Skipping 14@4
</code></pre>
<h3 id="run-validation">Run Validation</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> torch
<span style="color:#f92672">import</span> gc
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd

torch<span style="color:#f92672">.</span>cuda<span style="color:#f92672">.</span>empty_cache()

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">run_one</span>(scribe_model, ibe_model, no_scribe_model):
    scribe_model <span style="color:#f92672">=</span> scribe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>)
    ibe_model <span style="color:#f92672">=</span> ibe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>)
    no_scribe_model <span style="color:#f92672">=</span> no_scribe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>)
    scribe_model<span style="color:#f92672">.</span>eval()
    ibe_model<span style="color:#f92672">.</span>eval()
    no_scribe_model<span style="color:#f92672">.</span>eval()

    s_cm <span style="color:#f92672">=</span> RunningConfusionMatrix(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
    i_cm <span style="color:#f92672">=</span> RunningConfusionMatrix(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
    n_cm <span style="color:#f92672">=</span> RunningConfusionMatrix(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
    s_lt <span style="color:#f92672">=</span> RunningLogitTracker(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
    i_lt <span style="color:#f92672">=</span> RunningLogitTracker(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)
    n_lt <span style="color:#f92672">=</span> RunningLogitTracker(<span style="color:#ae81ff">21</span>, <span style="color:#ae81ff">255</span>)

    corr_val <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, 
                              transforms<span style="color:#f92672">=</span>ImLblTransform(False), 
                              image_set<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val&#39;</span>)

    corr_iter <span style="color:#f92672">=</span> data<span style="color:#f92672">.</span>DataLoader(corr_val, batch_size<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, shuffle<span style="color:#f92672">=</span>False, num_workers<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, pin_memory<span style="color:#f92672">=</span>True)
    pbar <span style="color:#f92672">=</span> tqdm(corr_iter, position<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, leave<span style="color:#f92672">=</span>True)
    <span style="color:#66d9ef">for</span> im,lbl <span style="color:#f92672">in</span> pbar:
        s_output <span style="color:#f92672">=</span> scribe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
        i_output <span style="color:#f92672">=</span> ibe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
        n_output <span style="color:#f92672">=</span> no_scribe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>))

        s_pred <span style="color:#f92672">=</span> s_output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)
        i_pred <span style="color:#f92672">=</span> i_output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)
        n_pred <span style="color:#f92672">=</span> n_output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)

        s_cm(s_pred, lbl<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
        i_cm(i_pred, lbl<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
        n_cm(n_pred, lbl<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>))

        s_iou <span style="color:#f92672">=</span> s_cm<span style="color:#f92672">.</span>iou
        s_miou <span style="color:#f92672">=</span> s_iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(s_iou)]<span style="color:#f92672">.</span>mean()
        i_iou <span style="color:#f92672">=</span> i_cm<span style="color:#f92672">.</span>iou
        i_miou <span style="color:#f92672">=</span> i_iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(i_iou)]<span style="color:#f92672">.</span>mean()
        n_iou <span style="color:#f92672">=</span> n_cm<span style="color:#f92672">.</span>iou
        n_miou <span style="color:#f92672">=</span> n_iou[<span style="color:#f92672">~</span>torch<span style="color:#f92672">.</span>isnan(n_iou)]<span style="color:#f92672">.</span>mean()

        s_lt(s_output)
        i_lt(i_output)
        n_lt(n_output)


        pbar<span style="color:#f92672">.</span>set_description(<span style="color:#e6db74">&#39;S/I/B: {:.3f} / {:.3f} / {:.3f}&#39;</span><span style="color:#f92672">.</span>format(s_miou,i_miou,n_miou))
    <span style="color:#66d9ef">return</span> s_lt, i_lt, n_lt

s_lt, i_lt, n_lt <span style="color:#f92672">=</span> run_one(scribe_model, ibe_model, no_scribe_model)</code></pre></div>
    </div>
</span>

<h2 id="dimensionality-analysis">Dimensionality Analysis</h2>
<h3 id="explained-variance">Explained Variance</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> sklearn.decomposition <span style="color:#f92672">import</span> PCA
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd

sns<span style="color:#f92672">.</span>set_style(<span style="color:#e6db74">&#34;whitegrid&#34;</span>)
sns<span style="color:#f92672">.</span>set_context(<span style="color:#e6db74">&#34;paper&#34;</span>, font_scale<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>, rc<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;lines.linewidth&#34;</span>: <span style="color:#ae81ff">2.5</span>})

pca_data <span style="color:#f92672">=</span> []

pca <span style="color:#f92672">=</span> PCA(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>)
pca<span style="color:#f92672">.</span>fit(s_lt<span style="color:#f92672">.</span>mean)
s_cs <span style="color:#f92672">=</span> pca<span style="color:#f92672">.</span>explained_variance_ratio_<span style="color:#f92672">.</span>cumsum()
pca <span style="color:#f92672">=</span> PCA(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>)
pca<span style="color:#f92672">.</span>fit(i_lt<span style="color:#f92672">.</span>mean)
i_cs <span style="color:#f92672">=</span> pca<span style="color:#f92672">.</span>explained_variance_ratio_<span style="color:#f92672">.</span>cumsum()
pca <span style="color:#f92672">=</span> PCA(n_components<span style="color:#f92672">=</span><span style="color:#ae81ff">21</span>)
pca<span style="color:#f92672">.</span>fit(n_lt<span style="color:#f92672">.</span>mean)
n_cs <span style="color:#f92672">=</span> pca<span style="color:#f92672">.</span>explained_variance_ratio_<span style="color:#f92672">.</span>cumsum()
<span style="color:#66d9ef">for</span> m, p <span style="color:#f92672">in</span> zip([<span style="color:#e6db74">&#39;SCrIBE&#39;</span>, <span style="color:#e6db74">&#39;IBE&#39;</span>, <span style="color:#e6db74">&#39;Baseline&#39;</span>],[s_cs, i_cs, n_cs]):
    <span style="color:#66d9ef">for</span> x,y <span style="color:#f92672">in</span> enumerate(p):
        _d <span style="color:#f92672">=</span> {
            <span style="color:#e6db74">&#39;Model&#39;</span>: m,
            <span style="color:#e6db74">&#39;Variant&#39;</span>: <span style="color:#e6db74">&#39;Single&#39;</span>,
            <span style="color:#e6db74">&#39;Component&#39;</span>:x,
            <span style="color:#e6db74">&#39;Explained Variance&#39;</span>:y
        }
        pca_data<span style="color:#f92672">.</span>append(_d)


pca_df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>DataFrame(pca_data)

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>[<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">3</span>])
sns<span style="color:#f92672">.</span>lineplot(ax<span style="color:#f92672">=</span>ax,data<span style="color:#f92672">=</span>pca_df, x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Component&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Explained Variance&#39;</span>, hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Model&#39;</span>, hue_order <span style="color:#f92672">=</span>[<span style="color:#e6db74">&#39;Baseline&#39;</span>, <span style="color:#e6db74">&#39;IBE&#39;</span>, <span style="color:#e6db74">&#39;SCrIBE&#39;</span>])</code></pre></div>
    </div>
</span>

<p><img src="index_43_1.png" alt="png"></p>
<h2 id="structural-analysis">Structural Analysis</h2>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> torchvision.utils <span style="color:#f92672">import</span> make_grid
<span style="color:#f92672">from</span> matplotlib.colors <span style="color:#f92672">import</span> LogNorm
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns
<span style="color:#f92672">from</span> mpl_toolkits.axes_grid1 <span style="color:#f92672">import</span> make_axes_locatable

sns<span style="color:#f92672">.</span>set(style<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;whitegrid&#34;</span>)
sns<span style="color:#f92672">.</span>set_context(<span style="color:#e6db74">&#34;poster&#34;</span>, font_scale<span style="color:#f92672">=</span><span style="color:#ae81ff">1.5</span>, rc<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;lines.linewidth&#34;</span>: <span style="color:#ae81ff">2.5</span>})
fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">4</span>))
s_mn <span style="color:#f92672">=</span> s_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()
i_mn <span style="color:#f92672">=</span> i_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()
n_mn <span style="color:#f92672">=</span> n_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()

s_r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>diagonal(s_mn)<span style="color:#f92672">-</span>s_mn[:,<span style="color:#ae81ff">0</span>]
i_r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>diagonal(i_mn)<span style="color:#f92672">-</span>i_mn[:,<span style="color:#ae81ff">0</span>]
n_r <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>diagonal(n_mn)<span style="color:#f92672">-</span>n_mn[:,<span style="color:#ae81ff">0</span>]


_mx <span style="color:#f92672">=</span> max([s_mn[s_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max(), i_mn[i_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max(), n_mn[n_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max()])
_mn <span style="color:#f92672">=</span> min([s_mn[s_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min(), i_mn[i_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min(), n_mn[n_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min()])

im <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>imshow(s_mn, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>imshow(i_mn, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>imshow(n_mn, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
cbar_ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0.95</span>, <span style="color:#ae81ff">0.15</span>, <span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.7</span>])
fig<span style="color:#f92672">.</span>colorbar(im, cax<span style="color:#f92672">=</span>cbar_ax)
plt<span style="color:#f92672">.</span>show()

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">4</span>))
s_mn <span style="color:#f92672">=</span> s_lt<span style="color:#f92672">.</span>dm<span style="color:#f92672">.</span>numpy()
i_mn <span style="color:#f92672">=</span> i_lt<span style="color:#f92672">.</span>dm<span style="color:#f92672">.</span>numpy()
n_mn <span style="color:#f92672">=</span> n_lt<span style="color:#f92672">.</span>dm<span style="color:#f92672">.</span>numpy()

_mx <span style="color:#f92672">=</span> max([s_mn[s_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max(), i_mn[i_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max(), n_mn[n_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max()])
_mn <span style="color:#f92672">=</span> min([s_mn[s_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min(), i_mn[i_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min(), n_mn[n_mn<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min()])

im <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>imshow(s_mn, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>imshow(i_mn, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>imshow(n_mn, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
cbar_ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0.95</span>, <span style="color:#ae81ff">0.15</span>, <span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.7</span>])
fig<span style="color:#f92672">.</span>colorbar(im, cax<span style="color:#f92672">=</span>cbar_ax)
plt<span style="color:#f92672">.</span>show()

s_im <span style="color:#f92672">=</span> make_grid(s_lt<span style="color:#f92672">.</span>cor<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, pad_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">255</span>)[<span style="color:#ae81ff">0</span>,:,:]<span style="color:#f92672">.</span>numpy()
i_im <span style="color:#f92672">=</span> make_grid(i_lt<span style="color:#f92672">.</span>cor<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, pad_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">255</span>)[<span style="color:#ae81ff">0</span>,:,:]<span style="color:#f92672">.</span>numpy()
n_im <span style="color:#f92672">=</span> make_grid(n_lt<span style="color:#f92672">.</span>cor<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, pad_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">255</span>)[<span style="color:#ae81ff">0</span>,:,:]<span style="color:#f92672">.</span>numpy()

_mx <span style="color:#f92672">=</span> max([s_im[s_im<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max(), n_im[n_im<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>max()])
_mn <span style="color:#f92672">=</span> min([s_im[s_im<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min(), n_im[n_im<span style="color:#f92672">!=-</span><span style="color:#ae81ff">255</span>]<span style="color:#f92672">.</span>min()])

<span style="color:#66d9ef">print</span>(_mn,_mx)

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">14</span>,<span style="color:#ae81ff">9</span>))
im <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>imshow(s_im, vmin<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
im <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>imshow(i_im, vmin<span style="color:#f92672">=</span><span style="color:#ae81ff">0.8</span>, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>imshow(n_im, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)
ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
cbar_ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0.95</span>, <span style="color:#ae81ff">0.15</span>, <span style="color:#ae81ff">0.05</span>, <span style="color:#ae81ff">0.7</span>])
fig<span style="color:#f92672">.</span>colorbar(im, cax<span style="color:#f92672">=</span>cbar_ax)</code></pre></div>
    </div>
</span>

<p><img src="index_44_0.png" alt="png"></p>
<p><img src="index_44_1.png" alt="png"></p>
<p><img src="index_44_4.png" alt="png"></p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">sns<span style="color:#f92672">.</span>set(style<span style="color:#f92672">=</span><span style="color:#e6db74">&#34;whitegrid&#34;</span>)
sns<span style="color:#f92672">.</span>set_context(<span style="color:#e6db74">&#34;paper&#34;</span>, font_scale<span style="color:#f92672">=</span><span style="color:#ae81ff">2.0</span>, rc<span style="color:#f92672">=</span>{<span style="color:#e6db74">&#34;lines.linewidth&#34;</span>: <span style="color:#ae81ff">2.5</span>})


s_im <span style="color:#f92672">=</span> make_grid(s_lt<span style="color:#f92672">.</span>cor[<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>]<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, pad_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">255</span>)[<span style="color:#ae81ff">0</span>,:,:]<span style="color:#f92672">.</span>numpy()
i_im <span style="color:#f92672">=</span> make_grid(i_lt<span style="color:#f92672">.</span>cor[<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>]<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, pad_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">255</span>)[<span style="color:#ae81ff">0</span>,:,:]<span style="color:#f92672">.</span>numpy()
n_im <span style="color:#f92672">=</span> make_grid(n_lt<span style="color:#f92672">.</span>cor[<span style="color:#f92672">-</span><span style="color:#ae81ff">8</span>:<span style="color:#f92672">-</span><span style="color:#ae81ff">7</span>]<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">1</span>), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">2</span>, pad_value<span style="color:#f92672">=-</span><span style="color:#ae81ff">255</span>)[<span style="color:#ae81ff">0</span>,:,:]<span style="color:#f92672">.</span>numpy()

s_mn <span style="color:#f92672">=</span> s_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()
i_mn <span style="color:#f92672">=</span> i_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()
n_mn <span style="color:#f92672">=</span> n_lt<span style="color:#f92672">.</span>mean<span style="color:#f92672">.</span>numpy()

_mn, _mx <span style="color:#f92672">=</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>

fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">3</span>, figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">3</span>))

ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;SCrIBE&#39;</span>)
im1 <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>imshow(s_im, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)

ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;IBE&#39;</span>)
im2 <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>imshow(i_im, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)

ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>set_title(<span style="color:#e6db74">&#39;Baseline&#39;</span>)
im3 <span style="color:#f92672">=</span> ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>imshow(n_im, vmin<span style="color:#f92672">=</span>_mn, vmax<span style="color:#f92672">=</span>_mx, cmap<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;plasma&#39;</span>)

ax[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">1</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax[<span style="color:#ae81ff">2</span>]<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
cbar_ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0.95</span>, <span style="color:#ae81ff">0.15</span>, <span style="color:#ae81ff">0.04</span>, <span style="color:#ae81ff">0.70</span>])
fig<span style="color:#f92672">.</span>colorbar(im3, cax<span style="color:#f92672">=</span>cbar_ax)
plt<span style="color:#f92672">.</span>show()</code></pre></div>
    </div>
</span>

<p><img src="index_45_0.png" alt="png"></p>
<h2 id="qualitative-result-visualizations">Qualitative Result Visualizations</h2>
<h3 id="make-a-list-of-images-from-validation-set">Make a list of images from Validation set</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> joint_transforms <span style="color:#f92672">import</span> FixedResize

<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImViewLblTransform</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self):
        im_tran <span style="color:#f92672">=</span>  [
            transforms<span style="color:#f92672">.</span>ToTensor(), 
            transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD)  
        ]
        
        self<span style="color:#f92672">.</span>joint_train <span style="color:#f92672">=</span> FixedResize(<span style="color:#ae81ff">224</span>)
        self<span style="color:#f92672">.</span>img_transform <span style="color:#f92672">=</span> transforms<span style="color:#f92672">.</span>Compose(im_tran)
            
    <span style="color:#66d9ef">def</span> __call__(self, img, lbl):
        img, lbl <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>joint_train(img, lbl)
        img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>img_transform(img)
        lbl <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>array(lbl)<span style="color:#f92672">.</span>astype(np<span style="color:#f92672">.</span>float32)
        lbl <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>from_numpy(lbl)<span style="color:#f92672">.</span>float()
        <span style="color:#66d9ef">return</span> img, lbl

voc_val <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, 
                          transforms<span style="color:#f92672">=</span>ImViewLblTransform(), 
                          image_set<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;val&#39;</span>)

val_set_list <span style="color:#f92672">=</span> []
<span style="color:#66d9ef">for</span> im, lbl <span style="color:#f92672">in</span> list(voc_val):
    im <span style="color:#f92672">=</span> im<span style="color:#f92672">*</span>torch<span style="color:#f92672">.</span>tensor(MEAN_STD[<span style="color:#e6db74">&#39;std&#39;</span>])<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span>torch<span style="color:#f92672">.</span>tensor(MEAN_STD[<span style="color:#e6db74">&#39;mean&#39;</span>])<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
    val_set_list<span style="color:#f92672">.</span>append(im)</code></pre></div>
    </div>
</span>

<h3 id="render-100-of-them-starting-at-some-index">Render 100 of them starting at some index</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">delta <span style="color:#f92672">=</span>  <span style="color:#ae81ff">700</span><span style="color:#75715e">#@param {type:&#34;integer&#34;}</span>
<span style="color:#f92672">from</span> torchvision.utils <span style="color:#f92672">import</span> make_grid
<span style="color:#f92672">import</span> matplotlib.patheffects <span style="color:#f92672">as</span> path_effects
img <span style="color:#f92672">=</span> make_grid(torch<span style="color:#f92672">.</span>stack(val_set_list[<span style="color:#ae81ff">0</span><span style="color:#f92672">+</span>delta:<span style="color:#ae81ff">100</span><span style="color:#f92672">+</span>delta]), nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">10</span>, padding<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()

fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">20</span>,<span style="color:#ae81ff">20</span>))
ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>])
plt<span style="color:#f92672">.</span>imshow(img)
n <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
<span style="color:#66d9ef">for</span> i <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
    <span style="color:#66d9ef">for</span> j <span style="color:#f92672">in</span> range(<span style="color:#ae81ff">10</span>):
        txt <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>text(<span style="color:#f92672">.</span><span style="color:#ae81ff">05</span><span style="color:#f92672">+</span>j<span style="color:#f92672">/</span><span style="color:#ae81ff">10</span>, <span style="color:#f92672">.</span><span style="color:#ae81ff">95</span><span style="color:#f92672">-</span>i<span style="color:#f92672">/</span><span style="color:#ae81ff">10</span>,
                 n<span style="color:#f92672">+</span>delta, 
                 horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
                 verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
                 transform<span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>transAxes
                )
        txt<span style="color:#f92672">.</span>set_path_effects([path_effects<span style="color:#f92672">.</span>Stroke(linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, foreground<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;white&#39;</span>),
                       path_effects<span style="color:#f92672">.</span>Normal()])
        n <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
plt<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
plt<span style="color:#f92672">.</span>show()</code></pre></div>
    </div>
</span>

<p><img src="index_49_0.png" alt="png"></p>
<h3 id="generate-results-to-visualize">Generate Results to Visualize</h3>
<p>Here we pick one from the group above and collect outputs for all models and corruptions at 3 levels for visualization. Crop top and crop bottom allow for adjusting the very tall figure.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">dataset_index <span style="color:#f92672">=</span>  <span style="color:#ae81ff">790</span><span style="color:#75715e">#@param {type:&#34;number&#34;}</span>
crop_top <span style="color:#f92672">=</span>  <span style="color:#ae81ff">50</span><span style="color:#75715e">#@param {type:&#34;number&#34;}</span>
crop_bot <span style="color:#f92672">=</span>  <span style="color:#ae81ff">1</span><span style="color:#75715e">#@param {type:&#34;number&#34;}</span>
Dataset <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;val&#34;</span> <span style="color:#75715e">#@param [&#34;val&#34;, &#34;train&#34;]</span>

<span style="color:#f92672">from</span> torchvision.utils <span style="color:#f92672">import</span> make_grid
<span style="color:#f92672">from</span> matplotlib.figure <span style="color:#f92672">import</span> figaspect
preds<span style="color:#f92672">=</span>[]
scribe_model <span style="color:#f92672">=</span> scribe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>)
no_scribe_model <span style="color:#f92672">=</span> no_scribe_model<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>)
scribe_model<span style="color:#f92672">.</span>eval()
no_scribe_model<span style="color:#f92672">.</span>eval()
corr_disp_list <span style="color:#f92672">=</span> [<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">7</span>,<span style="color:#ae81ff">10</span>,<span style="color:#ae81ff">12</span>]
sv_list <span style="color:#f92672">=</span> range(<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">4</span>)
<span style="color:#66d9ef">for</span> cn <span style="color:#f92672">in</span> corr_disp_list:
    <span style="color:#66d9ef">for</span> sv <span style="color:#f92672">in</span> sv_list:
        voc_val <span style="color:#f92672">=</span> VOCSegmentation(root<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;/data/datasets/&#39;</span>, 
                                  transforms<span style="color:#f92672">=</span>ImLblCorruptTransform(sv,cn), 
                                  image_set<span style="color:#f92672">=</span>Dataset)
 
        im, lbl <span style="color:#f92672">=</span> voc_val[dataset_index]
        c,h,w <span style="color:#f92672">=</span> im<span style="color:#f92672">.</span>shape
        output <span style="color:#f92672">=</span> scribe_model(im<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
        pred <span style="color:#f92672">=</span> output<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>squeeze()<span style="color:#f92672">.</span>numpy()
        pred <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(colorize_voc_label(pred)[:,:,:<span style="color:#ae81ff">3</span>])<span style="color:#f92672">.</span>float()<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
        
        noutput <span style="color:#f92672">=</span> no_scribe_model(im<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>))
        npred <span style="color:#f92672">=</span> noutput<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>squeeze()<span style="color:#f92672">.</span>numpy()
        npred <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(colorize_voc_label(npred)[:,:,:<span style="color:#ae81ff">3</span>])<span style="color:#f92672">.</span>float()<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
        lbl<span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>tensor(colorize_voc_label(lbl)[:,:,:<span style="color:#ae81ff">3</span>])<span style="color:#f92672">.</span>float()<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
        
        im <span style="color:#f92672">=</span> im<span style="color:#f92672">*</span>torch<span style="color:#f92672">.</span>tensor(MEAN_STD[<span style="color:#e6db74">&#39;std&#39;</span>])<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)<span style="color:#f92672">+</span>torch<span style="color:#f92672">.</span>tensor(MEAN_STD[<span style="color:#e6db74">&#39;mean&#39;</span>])<span style="color:#f92672">.</span>reshape(<span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>)
        im <span style="color:#f92672">=</span> im[:,crop_top:<span style="color:#f92672">-</span>crop_bot,:]
        pred <span style="color:#f92672">=</span> pred[:,crop_top:<span style="color:#f92672">-</span>crop_bot,:]
        npred <span style="color:#f92672">=</span> npred[:,crop_top:<span style="color:#f92672">-</span>crop_bot,:]
        lbl <span style="color:#f92672">=</span> lbl[:,crop_top:<span style="color:#f92672">-</span>crop_bot,:]
        imp <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>cat([im,npred,pred],<span style="color:#ae81ff">1</span>)
        preds<span style="color:#f92672">.</span>append(imp<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu())
        <span style="color:#66d9ef">if</span> sv<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span>:
            or_img <span style="color:#f92672">=</span> im<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
            or_lbl <span style="color:#f92672">=</span> lbl<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
            sm_lbl <span style="color:#f92672">=</span> nn<span style="color:#f92672">.</span>functional<span style="color:#f92672">.</span>interpolate(lbl<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>), scale_factor<span style="color:#f92672">=.</span><span style="color:#ae81ff">4</span>)<span style="color:#f92672">.</span>squeeze()
            sl_c,sl_h,sl_w <span style="color:#f92672">=</span> sm_lbl<span style="color:#f92672">.</span>shape
            oi_c,oi_h,oi_w <span style="color:#f92672">=</span> lbl<span style="color:#f92672">.</span>shape
            mod_img <span style="color:#f92672">=</span> im<span style="color:#f92672">.</span>clone()
            mod_img[:,oi_h<span style="color:#f92672">-</span>sl_h:,oi_w<span style="color:#f92672">-</span>sl_w:] <span style="color:#f92672">=</span> sm_lbl
            pristine <span style="color:#f92672">=</span> make_grid(torch<span style="color:#f92672">.</span>stack([mod_img,npred,pred]),nrow<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>,padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
            pristine_ <span style="color:#f92672">=</span> pristine<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>detach()<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
        </code></pre></div>
    </div>
</span>

<h3 id="visualize-that-collections">Visualize that collections</h3>
<p>This is the visualization code used to generate a figure in the paper.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">preds <span style="color:#f92672">=</span> torch<span style="color:#f92672">.</span>stack(preds)
preds <span style="color:#f92672">=</span> make_grid(preds,nrow<span style="color:#f92672">=</span>len(sv_list),padding<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>)
disp_im <span style="color:#f92672">=</span> preds<span style="color:#f92672">.</span>permute(<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>numpy()[<span style="color:#ae81ff">0</span>:len(corr_disp_list)<span style="color:#f92672">*</span>h<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>,<span style="color:#ae81ff">1</span><span style="color:#f92672">*</span>w:]
d_h,d_w,_ <span style="color:#f92672">=</span> disp_im<span style="color:#f92672">.</span>shape
p_h,p_w,_ <span style="color:#f92672">=</span> pristine_<span style="color:#f92672">.</span>shape
p_w <span style="color:#f92672">=</span> d_w<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span><span style="color:#f92672">/</span>(len(sv_list)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
p_h <span style="color:#f92672">*=</span> d_w<span style="color:#f92672">/</span>p_w
d_h <span style="color:#f92672">/=</span> <span style="color:#ae81ff">96</span>
d_w <span style="color:#f92672">/=</span> <span style="color:#ae81ff">96</span>
p_h <span style="color:#f92672">/=</span> <span style="color:#ae81ff">96</span>
p_w <span style="color:#f92672">/=</span> <span style="color:#ae81ff">96</span>
tot_h <span style="color:#f92672">=</span> (d_h<span style="color:#f92672">+</span>p_h)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.7</span>
tot_w <span style="color:#f92672">=</span> (d_w<span style="color:#f92672">+</span>p_w)<span style="color:#f92672">/</span><span style="color:#ae81ff">0.8</span>
plt<span style="color:#f92672">.</span>rcParams<span style="color:#f92672">.</span>update({<span style="color:#e6db74">&#39;font.size&#39;</span>: <span style="color:#ae81ff">18</span>})

fig <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>figure(figsize<span style="color:#f92672">=</span>(tot_w,tot_h))
ax_ <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0.1</span>,d_h<span style="color:#f92672">/</span>tot_h<span style="color:#f92672">+</span><span style="color:#ae81ff">0.12</span>,<span style="color:#ae81ff">0.8</span>,p_h<span style="color:#f92672">/</span>tot_h])
ax_<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
ax_<span style="color:#f92672">.</span>imshow(pristine_)
ax_<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">*</span><span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>, 
         <span style="color:#e6db74">&#39;Input&#39;</span>, 
         horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
         verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bottom&#39;</span>,
         transform<span style="color:#f92672">=</span>ax_<span style="color:#f92672">.</span>transAxes
        )
ax_<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1</span>, 
         <span style="color:#e6db74">&#39;Baseline&#39;</span>, 
         horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
         verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bottom&#39;</span>,
         transform<span style="color:#f92672">=</span>ax_<span style="color:#f92672">.</span>transAxes
        )
ax_<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">1.15</span>, 
         <span style="color:#e6db74">&#39;Original&#39;</span>, 
         horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
         verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bottom&#39;</span>,
         transform<span style="color:#f92672">=</span>ax_<span style="color:#f92672">.</span>transAxes,
         fontweight<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bold&#39;</span>
        )
ax_<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>)<span style="color:#f92672">+</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">*</span><span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">1</span>, 
         <span style="color:#e6db74">&#39;SCrIBE&#39;</span>, 
         horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
         verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bottom&#39;</span>,
         transform<span style="color:#f92672">=</span>ax_<span style="color:#f92672">.</span>transAxes
        )
ax <span style="color:#f92672">=</span> fig<span style="color:#f92672">.</span>add_axes([<span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">0.1</span>,<span style="color:#ae81ff">0.8</span>,d_h<span style="color:#f92672">/</span>tot_h])
ax<span style="color:#f92672">.</span>axis(<span style="color:#e6db74">&#39;off&#39;</span>)
n_corr <span style="color:#f92672">=</span> len(corr_disp_list)
y_start <span style="color:#f92672">=</span> (<span style="color:#ae81ff">1</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>n_corr<span style="color:#f92672">*</span><span style="color:#ae81ff">3</span>))
y_step <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(n_corr)
ax<span style="color:#f92672">.</span>imshow(disp_im)
<span style="color:#66d9ef">for</span> j, cn <span style="color:#f92672">in</span> enumerate(corr_disp_list):
    nm <span style="color:#f92672">=</span> corruption_tuple[cn]<span style="color:#f92672">.</span>__name__<span style="color:#f92672">.</span>split(<span style="color:#e6db74">&#39;_&#39;</span>)[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>capitalize()
    ax<span style="color:#f92672">.</span>text(<span style="color:#f92672">-.</span><span style="color:#ae81ff">01</span>,y_start<span style="color:#f92672">-</span>y_step<span style="color:#f92672">*</span>j, nm, 
             horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;right&#39;</span>,
             verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
             transform<span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>transAxes,
            rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span>,
             fontweight<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bold&#39;</span>
            )
    ax<span style="color:#f92672">.</span>text(<span style="color:#f92672">-.</span><span style="color:#ae81ff">01</span>,y_start<span style="color:#f92672">-</span>y_step<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span>y_step<span style="color:#f92672">*</span>j, 
            <span style="color:#e6db74">&#39;Baseline&#39;</span>, 
             horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;right&#39;</span>,
             verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
            rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span>,
             transform<span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>transAxes
            )
    ax<span style="color:#f92672">.</span>text(<span style="color:#f92672">-.</span><span style="color:#ae81ff">01</span>,y_start<span style="color:#f92672">-</span><span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>y_step<span style="color:#f92672">/</span><span style="color:#ae81ff">3</span><span style="color:#f92672">-</span>y_step<span style="color:#f92672">*</span>j, 
            <span style="color:#e6db74">&#39;SCrIBE&#39;</span>, 
             horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;right&#39;</span>,
             verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
            rotation<span style="color:#f92672">=</span><span style="color:#ae81ff">90</span>,
             transform<span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>transAxes
            )
x_start <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">*</span>(len(sv_list)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>))
x_step <span style="color:#f92672">=</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">/</span>(len(sv_list)<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>)
<span style="color:#66d9ef">for</span> sv <span style="color:#f92672">in</span> sv_list[<span style="color:#ae81ff">1</span>:]:
    ax<span style="color:#f92672">.</span>text(x_start<span style="color:#f92672">+</span>x_step<span style="color:#f92672">*</span>(sv<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),<span style="color:#ae81ff">1</span>, 
             sv, 
             horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
             verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bottom&#39;</span>,
             transform<span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>transAxes
            )
    
ax<span style="color:#f92672">.</span>text(x_start<span style="color:#f92672">+</span>x_step<span style="color:#f92672">*</span>(<span style="color:#ae81ff">2</span><span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>),<span style="color:#ae81ff">1.01</span>, 
         <span style="color:#e6db74">&#39;Corrupted&#39;</span>, 
         horizontalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;center&#39;</span>,
         verticalalignment<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bottom&#39;</span>,
         transform<span style="color:#f92672">=</span>ax<span style="color:#f92672">.</span>transAxes,
         fontweight<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bold&#39;</span>
        )
    
display()</code></pre></div>
    </div>
</span>

<p><img src="index_50_0.png" alt="png"></p>
<h3 id="performance-comparison-plot">Performance Comparison Plot</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib <span style="color:#f92672">as</span> mpl
<span style="color:#f92672">import</span> seaborn <span style="color:#f92672">as</span> sns
<span style="color:#f92672">import</span> pandas <span style="color:#f92672">as</span> pd
sns<span style="color:#f92672">.</span>set_style(<span style="color:#e6db74">&#34;whitegrid&#34;</span>)
sns<span style="color:#f92672">.</span>set_context(<span style="color:#e6db74">&#34;poster&#34;</span>)
df <span style="color:#f92672">=</span> pd<span style="color:#f92672">.</span>read_pickle(<span style="color:#e6db74">&#39;data/DistCombined.pkl&#39;</span>)

rgbs <span style="color:#f92672">=</span> [(<span style="color:#ae81ff">213</span><span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">94</span><span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">0</span><span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>), (<span style="color:#ae81ff">86</span><span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">180</span><span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>, <span style="color:#ae81ff">233</span><span style="color:#f92672">/</span><span style="color:#ae81ff">255</span>), (<span style="color:#f92672">.</span><span style="color:#ae81ff">9</span>, <span style="color:#f92672">.</span><span style="color:#ae81ff">9</span>, <span style="color:#f92672">.</span><span style="color:#ae81ff">9</span>)]

cblind <span style="color:#f92672">=</span> [mpl<span style="color:#f92672">.</span>colors<span style="color:#f92672">.</span>to_hex(r) <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> rgbs]
cblind_gray <span style="color:#f92672">=</span> [mpl<span style="color:#f92672">.</span>colors<span style="color:#f92672">.</span>to_hex(
    mpl<span style="color:#f92672">.</span>colors<span style="color:#f92672">.</span>hsv_to_rgb(mpl<span style="color:#f92672">.</span>colors<span style="color:#f92672">.</span>rgb_to_hsv(r) <span style="color:#f92672">*</span> (<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)))
    <span style="color:#66d9ef">for</span> r <span style="color:#f92672">in</span> rgbs]

pal <span style="color:#f92672">=</span> sns<span style="color:#f92672">.</span>color_palette(cblind)
sns<span style="color:#f92672">.</span>palplot(pal)
fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">9</span><span style="color:#f92672">*</span><span style="color:#ae81ff">1.618</span>,<span style="color:#ae81ff">7</span>))
sns<span style="color:#f92672">.</span>lineplot(x<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Severity&#39;</span>, y<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;mIOU&#39;</span>, data<span style="color:#f92672">=</span>df, ax<span style="color:#f92672">=</span>ax, hue<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Model&#39;</span>)
<span style="color:#75715e">#plt.legend(bbox_to_anchor=(1.05,1), loc=2, borderaxespad=0.)</span></code></pre></div>
    </div>
</span>

<p><img src="index_52_2.png" alt="png"></p>
<h2 id="example-videos">Example Videos</h2>
<h3 id="load-the-video">Load the video</h3>
<p>Here we provide the code that was used to produce the introduction demo that was used in the presentation video.

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> skvideo.io  
video <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;walkAS.mp4&#39;</span>
videodata <span style="color:#f92672">=</span> skvideo<span style="color:#f92672">.</span>io<span style="color:#f92672">.</span>vread(f<span style="color:#e6db74">&#39;example_videos/{video}&#39;</span>)  </code></pre></div>
    </div>
</span>
</p>
<h3 id="prepare-the-corrupting-transform">Prepare the corrupting transform</h3>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">ImCorruptTransform</span>(object):
    <span style="color:#66d9ef">def</span> __init__(self, severity, corruption_number, red_size):
        corrupt_partial <span style="color:#f92672">=</span> partial(corrupt, severity<span style="color:#f92672">=</span>severity, corruption_number<span style="color:#f92672">=</span>corruption_number)
        self<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> sz: transforms<span style="color:#f92672">.</span>Compose(
            [
            np<span style="color:#f92672">.</span>array,
            corrupt_partial,
            Image<span style="color:#f92672">.</span>fromarray,
            transforms<span style="color:#f92672">.</span>Resize(sz),
            transforms<span style="color:#f92672">.</span>ToTensor(), 
            transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD),
            ]
        )
        <span style="color:#66d9ef">if</span> severity <span style="color:#f92672">==</span> <span style="color:#ae81ff">0</span>:
            self<span style="color:#f92672">.</span>transform <span style="color:#f92672">=</span> <span style="color:#66d9ef">lambda</span> sz: transforms<span style="color:#f92672">.</span>Compose(
                [
                transforms<span style="color:#f92672">.</span>Resize(sz),
                transforms<span style="color:#f92672">.</span>ToTensor(), 
                transforms<span style="color:#f92672">.</span>Normalize(<span style="color:#f92672">**</span>MEAN_STD)   
                ]
            )
        self<span style="color:#f92672">.</span>red_size <span style="color:#f92672">=</span> red_size
        
            
    <span style="color:#66d9ef">def</span> __call__(self, img):
        img <span style="color:#f92672">=</span> Image<span style="color:#f92672">.</span>fromarray(img)
        img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize(self<span style="color:#f92672">.</span>red_size)
        W,H <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>size
        sz <span style="color:#f92672">=</span> (H,W)
        img <span style="color:#f92672">=</span> img<span style="color:#f92672">.</span>resize((<span style="color:#ae81ff">224</span>,<span style="color:#ae81ff">224</span>),Image<span style="color:#f92672">.</span>BILINEAR)
        img <span style="color:#f92672">=</span> self<span style="color:#f92672">.</span>transform(sz)(img)
        <span style="color:#66d9ef">return</span> img
    </code></pre></div>
    </div>
</span>

<h3 id="generate-the-demo-video">Generate the demo video</h3>
<p>Here we equally divide the frames amongst corruptions and processing them through SCrIBE and the baseline models.</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">ns_preds <span style="color:#f92672">=</span> []
s_preds <span style="color:#f92672">=</span> []
ims <span style="color:#f92672">=</span> []
corr_ims <span style="color:#f92672">=</span> []
corr_txts <span style="color:#f92672">=</span> []
switch <span style="color:#f92672">=</span> videodata<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">//</span><span style="color:#ae81ff">13</span>
sv <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>
cn <span style="color:#f92672">=</span><span style="color:#ae81ff">0</span> 


pbar <span style="color:#f92672">=</span> tqdm(enumerate(videodata), total<span style="color:#f92672">=</span>videodata<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>])
<span style="color:#66d9ef">for</span> k, im <span style="color:#f92672">in</span> pbar:
    <span style="color:#66d9ef">if</span> k<span style="color:#f92672">%</span>switch<span style="color:#f92672">==</span><span style="color:#ae81ff">0</span> <span style="color:#f92672">and</span> k<span style="color:#f92672">!=</span><span style="color:#ae81ff">0</span>:
        sv <span style="color:#f92672">=</span> <span style="color:#ae81ff">2</span>
        cn <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> cn <span style="color:#f92672">==</span> <span style="color:#ae81ff">8</span>:
            cn <span style="color:#f92672">+=</span> <span style="color:#ae81ff">1</span>
        <span style="color:#66d9ef">if</span> cn <span style="color:#f92672">==</span> <span style="color:#ae81ff">12</span>:
            sv <span style="color:#f92672">=</span> <span style="color:#ae81ff">3</span>
    <span style="color:#66d9ef">if</span> cn <span style="color:#f92672">&gt;</span> <span style="color:#ae81ff">0</span>:
        corr_txts<span style="color:#f92672">.</span>append(corruption_tuple[cn]<span style="color:#f92672">.</span>__name__)
    <span style="color:#66d9ef">else</span>:
        corr_txts<span style="color:#f92672">.</span>append(<span style="color:#e6db74">&#39;None&#39;</span>)
    pbar<span style="color:#f92672">.</span>set_description(corr_txts[<span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>])
    transform <span style="color:#f92672">=</span> ImCorruptTransform(sv,cn, (<span style="color:#ae81ff">480</span>,<span style="color:#ae81ff">270</span>))
    ims<span style="color:#f92672">.</span>append(np<span style="color:#f92672">.</span>array(transforms<span style="color:#f92672">.</span>Resize(<span style="color:#ae81ff">270</span>)(Image<span style="color:#f92672">.</span>fromarray(im))))
    im <span style="color:#f92672">=</span> transform(im)
    corr_ims<span style="color:#f92672">.</span>append(im<span style="color:#f92672">.</span>permute([<span style="color:#ae81ff">1</span>,<span style="color:#ae81ff">2</span>,<span style="color:#ae81ff">0</span>])<span style="color:#f92672">.</span>numpy())
    im <span style="color:#f92672">=</span> im<span style="color:#f92672">.</span>unsqueeze(<span style="color:#ae81ff">0</span>)
    
    s_pred <span style="color:#f92672">=</span> scribe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">0</span>))
    s_pred <span style="color:#f92672">=</span> s_pred<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
    s_c_out <span style="color:#f92672">=</span> colorize_voc_label(s_pred)
    s_preds<span style="color:#f92672">.</span>append(s_c_out[:,:,:,:<span style="color:#ae81ff">3</span>])
    
    ns_pred <span style="color:#f92672">=</span> no_scribe_model(im<span style="color:#f92672">.</span>to(<span style="color:#ae81ff">1</span>))
    ns_pred <span style="color:#f92672">=</span> ns_pred<span style="color:#f92672">.</span>argmax(<span style="color:#ae81ff">1</span>)<span style="color:#f92672">.</span>cpu()<span style="color:#f92672">.</span>numpy()
    ns_c_out <span style="color:#f92672">=</span> colorize_voc_label(ns_pred)
    ns_preds<span style="color:#f92672">.</span>append(ns_c_out[:,:,:,:<span style="color:#ae81ff">3</span>])
ns_preds <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate(ns_preds)
s_preds <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate(s_preds)</code></pre></div>
    </div>
</span>

<h3 id="animate">Animate</h3>
<p>This takes a while. I am sure there is a faster way&hellip;</p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">import</span> matplotlib.pyplot <span style="color:#f92672">as</span> plt
<span style="color:#f92672">from</span> matplotlib <span style="color:#f92672">import</span> animation, rc
rc(<span style="color:#e6db74">&#39;animation&#39;</span>, html<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;html5&#39;</span>)
<span style="color:#66d9ef">print</span>(ims[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>shape, corr_ims[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>shape)
<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">join_ex</span>(im,corrim,ns_pred,s_pred):
    im <span style="color:#f92672">=</span> im<span style="color:#f92672">/</span><span style="color:#ae81ff">255.0</span>
    corrim <span style="color:#f92672">=</span> corrim<span style="color:#f92672">*</span>MEAN_STD[<span style="color:#e6db74">&#39;std&#39;</span>]<span style="color:#f92672">+</span>MEAN_STD[<span style="color:#e6db74">&#39;mean&#39;</span>]
    corrim <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>clip(corrim,<span style="color:#ae81ff">0</span>,<span style="color:#ae81ff">1</span>)
    top <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate([im, corrim],<span style="color:#ae81ff">1</span>)
    bot <span style="color:#f92672">=</span> np<span style="color:#f92672">.</span>concatenate([ns_pred, s_pred],<span style="color:#ae81ff">1</span>)
    <span style="color:#66d9ef">return</span> np<span style="color:#f92672">.</span>concatenate([top,bot], <span style="color:#ae81ff">0</span>)
    

my_dpi <span style="color:#f92672">=</span> <span style="color:#ae81ff">960</span>
fig, ax <span style="color:#f92672">=</span> plt<span style="color:#f92672">.</span>subplots(<span style="color:#ae81ff">1</span>,figsize<span style="color:#f92672">=</span>(<span style="color:#ae81ff">1920</span><span style="color:#f92672">/</span>my_dpi, <span style="color:#ae81ff">1080</span><span style="color:#f92672">/</span>my_dpi), dpi<span style="color:#f92672">=</span>my_dpi)
vis <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>imshow(join_ex(ims[<span style="color:#ae81ff">0</span>],corr_ims[<span style="color:#ae81ff">0</span>], ns_preds[<span style="color:#ae81ff">0</span>], s_preds[<span style="color:#ae81ff">0</span>]))
corrtxt <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">500</span>, <span style="color:#ae81ff">30</span>, f<span style="color:#e6db74">&#39;Corruption: None&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>, fontweight<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bold&#39;</span>)
corrtxt<span style="color:#f92672">.</span>set_path_effects([path_effects<span style="color:#f92672">.</span>Stroke(linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, foreground<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>), path_effects<span style="color:#f92672">.</span>Normal()]) 
theirs <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">20</span>, <span style="color:#ae81ff">300</span>, f<span style="color:#e6db74">&#39;Theirs&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>, fontweight<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bold&#39;</span>)
theirs<span style="color:#f92672">.</span>set_path_effects([path_effects<span style="color:#f92672">.</span>Stroke(linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, foreground<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>), path_effects<span style="color:#f92672">.</span>Normal()]) 
ours <span style="color:#f92672">=</span> ax<span style="color:#f92672">.</span>text(<span style="color:#ae81ff">500</span>, <span style="color:#ae81ff">300</span>, f<span style="color:#e6db74">&#39;Ours&#39;</span>, fontsize<span style="color:#f92672">=</span><span style="color:#ae81ff">3</span>, color<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;red&#39;</span>, fontweight<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;bold&#39;</span>)
ours<span style="color:#f92672">.</span>set_path_effects([path_effects<span style="color:#f92672">.</span>Stroke(linewidth<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, foreground<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;black&#39;</span>), path_effects<span style="color:#f92672">.</span>Normal()]) 

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">animate</span>(i):
    corrtxt<span style="color:#f92672">.</span>set_text(f<span style="color:#e6db74">&#39;Corruption: {corr_txts[i]}&#39;</span>)
    vis<span style="color:#f92672">.</span>set_array(join_ex(ims[i],corr_ims[i], ns_preds[i], s_preds[i]))
    <span style="color:#66d9ef">return</span> [vis]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">init</span>():
    vis<span style="color:#f92672">.</span>set_array(join_ex(ims[<span style="color:#ae81ff">0</span>],corr_ims[<span style="color:#ae81ff">0</span>], ns_preds[<span style="color:#ae81ff">0</span>], s_preds[<span style="color:#ae81ff">0</span>]))
    <span style="color:#66d9ef">return</span> [vis]
    
fig<span style="color:#f92672">.</span>tight_layout()
fig<span style="color:#f92672">.</span>subplots_adjust(left<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, bottom<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>, right<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, top<span style="color:#f92672">=</span><span style="color:#ae81ff">1</span>, wspace<span style="color:#f92672">=</span>None, hspace<span style="color:#f92672">=</span>None)
ax<span style="color:#f92672">.</span>set_axis_off()
ani <span style="color:#f92672">=</span> animation<span style="color:#f92672">.</span>FuncAnimation(fig, animate, frames<span style="color:#f92672">=</span>s_preds<span style="color:#f92672">.</span>shape[<span style="color:#ae81ff">0</span>], interval<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>, blit<span style="color:#f92672">=</span>True, init_func<span style="color:#f92672">=</span>init)
    </code></pre></div>
    </div>
</span>

<pre><code>(270, 480, 3) (270, 480, 3)
</code></pre>
<p><img src="index_58_1.png" alt="png"></p>

<style>
 .definition {
     visibility: hidden;
     width: 120px;
     background-color: #555;
     color: #fff;
     text-align: center;
     border-radius: 6px;
     padding: 5px 0;
     position: absolute;
     z-index: 1;
     bottom: 125%;
     left: 50%;
     margin-left: -60px;
     opacity: 0;
     transition: opacity 0.3s;
 }
 
 .term {
     position: relative;
     display: inline-block;
     border-bottom: 1px dotted black;}
 
 .term:hover .definition {
     visibility: visible;
     opacity: 1;
 }
</style>
<span class="expand">
    <span class="expand-label" style="cursor: pointer;" onclick="$h = $(this);$h.next('div').slideToggle(100,function () {$h.children('i').attr('class',function () {return $h.next('div').is(':visible') ? 'fas fa-chevron-down' : 'fas fa-fas fa-chevron-right';});});">
        show code
        <i class="fas fa-chevron-right"></i>
    </span>
    <div class="expand-content" style="display: none; margin: 10px 0px 10px">
        <div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># Set up formatting for the movie files</span>
Writer <span style="color:#f92672">=</span> animation<span style="color:#f92672">.</span>writers[<span style="color:#e6db74">&#39;ffmpeg&#39;</span>]
writer <span style="color:#f92672">=</span> Writer(fps<span style="color:#f92672">=</span><span style="color:#ae81ff">30</span>, metadata<span style="color:#f92672">=</span>dict(artist<span style="color:#f92672">=</span><span style="color:#e6db74">&#39;Me&#39;</span>), bitrate<span style="color:#f92672">=</span><span style="color:#ae81ff">18000</span>)
ani<span style="color:#f92672">.</span>save(f<span style="color:#e6db74">&#39;example_videos/scribe_pred_{video}&#39;</span>, writer<span style="color:#f92672">=</span>writer)</code></pre></div>
    </div>
</span>

<p>Thank you for making it to the bottom of this post.  I hope you will feel more comfortable reproducing our work.  Please feel free to contact me with any questions or comments.</p>

    </div>

    




<div class="article-tags">
  
  <a class="badge badge-light" href="/tag/special-session/">Special Session</a>
  
  <a class="badge badge-light" href="/tag/icip/">ICIP</a>
  
</div>



<div class="share-box" aria-hidden="true">
  <ul class="share">
    
      
      
      
        
      
      
      
      <li>
        <a href="https://twitter.com/intent/tweet?url=https://charlielehman.github.io/post/on-the-structures-of-representation/&amp;text=On%20the%20Structures%20of%20Representation%20for%20the%20Robustness%20of%20Semantic%20Segmentation%20to%20Input%20Corruption" target="_blank" rel="noopener" class="share-btn-twitter">
          <i class="fab fa-twitter"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.facebook.com/sharer.php?u=https://charlielehman.github.io/post/on-the-structures-of-representation/&amp;t=On%20the%20Structures%20of%20Representation%20for%20the%20Robustness%20of%20Semantic%20Segmentation%20to%20Input%20Corruption" target="_blank" rel="noopener" class="share-btn-facebook">
          <i class="fab fa-facebook"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="mailto:?subject=On%20the%20Structures%20of%20Representation%20for%20the%20Robustness%20of%20Semantic%20Segmentation%20to%20Input%20Corruption&amp;body=https://charlielehman.github.io/post/on-the-structures-of-representation/" target="_blank" rel="noopener" class="share-btn-email">
          <i class="fas fa-envelope"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://www.linkedin.com/shareArticle?url=https://charlielehman.github.io/post/on-the-structures-of-representation/&amp;title=On%20the%20Structures%20of%20Representation%20for%20the%20Robustness%20of%20Semantic%20Segmentation%20to%20Input%20Corruption" target="_blank" rel="noopener" class="share-btn-linkedin">
          <i class="fab fa-linkedin-in"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="whatsapp://send?text=On%20the%20Structures%20of%20Representation%20for%20the%20Robustness%20of%20Semantic%20Segmentation%20to%20Input%20Corruption%20https://charlielehman.github.io/post/on-the-structures-of-representation/" target="_blank" rel="noopener" class="share-btn-whatsapp">
          <i class="fab fa-whatsapp"></i>
        </a>
      </li>
    
      
      
      
        
      
      
      
      <li>
        <a href="https://service.weibo.com/share/share.php?url=https://charlielehman.github.io/post/on-the-structures-of-representation/&amp;title=On%20the%20Structures%20of%20Representation%20for%20the%20Robustness%20of%20Semantic%20Segmentation%20to%20Input%20Corruption" target="_blank" rel="noopener" class="share-btn-weibo">
          <i class="fab fa-weibo"></i>
        </a>
      </li>
    
  </ul>
</div>











  
  
    



  
  
  
    
  
  
  
  <div class="media author-card content-widget-hr">
    
      
      <a href="https://charlielehman.github.io/"><img class="avatar mr-3 avatar-circle" src="/author/charlie-lehman/avatar_hub95f79b043710624bf10efdf38a7f380_4239507_270x270_fill_lanczos_center_2.png" alt="Charlie Lehman"></a>
    

    <div class="media-body">
      <h5 class="card-title"><a href="https://charlielehman.github.io/">Charlie Lehman</a></h5>
      <h6 class="card-subtitle">PhD Student</h6>
      <p class="card-text">My research interests include robustness and explainability of deep vision models.</p>
      <ul class="network-icon" aria-hidden="true">
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="/#contact" >
        <i class="fas fa-envelope"></i>
      </a>
    </li>
  
    
    
    
    
    
    
    
      
    
    <li>
      <a href="https://scholar.google.com/citations?user=TLfDqLcAAAAJ" target="_blank" rel="noopener">
        <i class="ai ai-google-scholar"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://github.com/charlieLehman" target="_blank" rel="noopener">
        <i class="fab fa-github"></i>
      </a>
    </li>
  
    
    
    
      
    
    
    
    
    
      
    
    <li>
      <a href="https://linkedin.com/in/charlieklehman" target="_blank" rel="noopener">
        <i class="fab fa-linkedin"></i>
      </a>
    </li>
  
</ul>

    </div>
  </div>


  
    




  
    




  












  
  
  <div class="article-widget content-widget-hr">
    <h3>Related</h3>
    <ul>
      
      <li><a href="/talk/icip2020-on-the-structures/">On the Structures of Representation for the Robustness of Semantic Segmentation to Input Corruption</a></li>
      
      <li><a href="/talk/icip2020-robustness-and-overfitting/">Robustness and Overfitting Behavior of Implicit Background Models</a></li>
      
      <li><a href="/publication/robustness-and-overfitting/">Robustness and Overfitting Behavior of Implicit Background Models</a></li>
      
      <li><a href="/talk/icip2020-s6/">S6:Semi-Supervised Self-Supervised Semantic Segmentation</a></li>
      
      <li><a href="/publication/s6/">S6:Semi-Supervised Self-Supervised Semantic Segmentation</a></li>
      
    </ul>
  </div>
  





  </div>
</article>

      

    
    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.imagesloaded/4.1.4/imagesloaded.pkgd.min.js" integrity="sha256-lqvxZrPLtfffUl2G/e7szqSvPBILGbwmsGE1MKlOi0Q=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.isotope/3.0.6/isotope.pkgd.min.js" integrity="sha256-CBrpuqrMhXwcLLUd5tvQ4euBHCdh7wGlDfNz8vbu/iI=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/fancybox/3.5.7/jquery.fancybox.min.js" integrity="sha256-yt2kYMy0w8AbtF89WXb2P1rfjcP/HTHLT7097U8Y5b8=" crossorigin="anonymous"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/instant.page/5.1.0/instantpage.min.js" integrity="sha512-1+qUtKoh9XZW7j+6LhRMAyOrgSQKenQ4mluTR+cvxXjP1Z54RxZuzstR/H9kgPXQsVB8IW7DMDFUJpzLjvhGSQ==" crossorigin="anonymous"></script>

      

      
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/highlight.min.js" integrity="sha512-TDKKr+IvoqZnPzc3l35hdjpHD0m+b2EC2SrLEgKDRWpxf2rFCxemkgvJ5kfU48ip+Y+m2XVKyOCD85ybtlZDmw==" crossorigin="anonymous"></script>
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.2.0/languages/r.min.js"></script>
        
      

    

    
    
      <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/leaflet.min.js" integrity="sha512-SeiQaaDh73yrb56sTW/RgVdi/mMqNeM2oBwubFHagc5BkixSpP1fvqF47mKzPGWYSSy4RwbBunrJBQ4Co8fRWA==" crossorigin="anonymous"></script>
    

    
    
    <script>const code_highlighting = true;</script>
    

    
    
    
    
    
    
    <script>
      const search_config = {"indexURI":"/index.json","minLength":1,"threshold":0.3};
      const i18n = {"no_results":"No results found","placeholder":"Search...","results":"results found"};
      const content_type = {
        'post': "Posts",
        'project': "Projects",
        'publication' : "Publications",
        'talk' : "Talks",
        'slides' : "Slides"
        };
    </script>
    

    
    

    
    
    <script id="search-hit-fuse-template" type="text/x-template">
      <div class="search-hit" id="summary-{{key}}">
      <div class="search-hit-content">
        <div class="search-hit-name">
          <a href="{{relpermalink}}">{{title}}</a>
          <div class="article-metadata search-hit-type">{{type}}</div>
          <p class="search-hit-description">{{snippet}}</p>
        </div>
      </div>
      </div>
    </script>
    

    
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/3.2.1/fuse.min.js" integrity="sha256-VzgmKYmhsGNNN4Ph1kMW+BjoYJM2jV5i4IlFoeZA9XI=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js" integrity="sha256-4HLtjeVgH0eIB3aZ9mLYF6E8oU5chNdjU6p6rrXpl9U=" crossorigin="anonymous"></script>
    

    
    

    
    

    
    

    
    

    
    
    
    
    
    
    
    
    
      
    
    
    
    
    <script src="/js/wowchemy.min.4c2bca31150ce93c5a5e43b8a50f22fd.js"></script>

    






  
  
  <div class="container">
    <footer class="site-footer">
  
  <p class="powered-by">
    
      <a href="/privacy/">Privacy Policy</a>
    
    
       &middot; 
      <a href="/terms/">Terms</a>
    
  </p>
  

  <p class="powered-by">
    
  </p>

  
  






  <p class="powered-by">
    
    Published with
    <a href="https://wowchemy.com" target="_blank" rel="noopener">Wowchemy</a>  
    the free, <a href="https://github.com/wowchemy/wowchemy-hugo-modules" target="_blank" rel="noopener">
    open source</a> website builder that empowers creators.
    

    
    <span class="float-right" aria-hidden="true">
      <a href="#" class="back-to-top">
        <span class="button_icon">
          <i class="fas fa-chevron-up fa-2x"></i>
        </span>
      </a>
    </span>
    
  </p>
</footer>

  </div>
  

  
<div id="modal" class="modal fade" role="dialog">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Cite</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <pre><code class="tex hljs"></code></pre>
      </div>
      <div class="modal-footer">
        <a class="btn btn-outline-primary my-1 js-copy-cite" href="#" target="_blank">
          <i class="fas fa-copy"></i> Copy
        </a>
        <a class="btn btn-outline-primary my-1 js-download-cite" href="#" target="_blank">
          <i class="fas fa-download"></i> Download
        </a>
        <div id="modal-error"></div>
      </div>
    </div>
  </div>
</div>

</body>
</html>
